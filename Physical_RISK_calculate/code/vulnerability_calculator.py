#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
Vulnerability Calculator (V)
ì·¨ì•½ì„± ê³„ì‚°: ê±´ë¬¼ì´ ì¬ë‚œì— ì–¼ë§ˆë‚˜ ì•½í•œê°€?
"""

from typing import Dict


class VulnerabilityCalculator:
    """
    ì·¨ì•½ì„±(Vulnerability) ê³„ì‚°ê¸°

    ì…ë ¥: Exposure ë°ì´í„°
    ì¶œë ¥: 9ê°œ ë¦¬ìŠ¤í¬ë³„ Vulnerability ì ìˆ˜

    Vulnerability ì •ì˜:
    - ê±´ë¬¼ì˜ êµ¬ì¡°ì , ê¸°ëŠ¥ì  ì•½ì 
    - ì¬ë‚œ ë°œìƒ ì‹œ í”¼í•´ë¥¼ ì–¼ë§ˆë‚˜ ë°›ì„ ê²ƒì¸ê°€?
    - ê±´ë¬¼ ì—°ì‹, êµ¬ì¡°, ë‚´ì§„ ì„¤ê³„, ì†Œë°©ì‹œì„¤ ë“±
    """

    def calculate(self, exposure: Dict) -> Dict:
        """
        Exposure ë°ì´í„° â†’ 9ê°œ ë¦¬ìŠ¤í¬ë³„ Vulnerability

        Args:
            exposure: ExposureCalculatorì˜ ì¶œë ¥

        Returns:
            Vulnerability ì ìˆ˜ ë”•ì…”ë„ˆë¦¬
        """
        print(f"\n{'='*80}")
        print(f"[Vulnerability Calculator] ì·¨ì•½ì„± ê³„ì‚°")
        print(f"{'='*80}")

        building = exposure['building']

        # 9ê°œ ë¦¬ìŠ¤í¬ë³„ Vulnerability ê³„ì‚°
        vulnerability = {
            'extreme_heat': self._calculate_heat_vulnerability(exposure),
            'extreme_cold': self._calculate_cold_vulnerability(exposure),
            'drought': self._calculate_drought_vulnerability(exposure),
            'inland_flood': self._calculate_inland_flood_vulnerability(exposure),
            'urban_flood': self._calculate_urban_flood_vulnerability(exposure),
            'coastal_flood': self._calculate_coastal_flood_vulnerability(exposure),
            'typhoon': self._calculate_typhoon_vulnerability(exposure),
            'wildfire': self._calculate_wildfire_vulnerability(exposure),
            'water_stress': self._calculate_water_stress_vulnerability(exposure),
        }

        print(f"\nâœ… ì·¨ì•½ì„± ê³„ì‚° ì™„ë£Œ")
        self._print_summary(vulnerability, building)

        return vulnerability

    # ========================================================================
    # 1. ê·¹í•œ ê³ ì˜¨ (Extreme Heat) ì·¨ì•½ì„±
    # ========================================================================

    def _calculate_heat_vulnerability(self, exposure: Dict) -> Dict:
        """
        ê·¹í•œ ê³ ì˜¨ ì·¨ì•½ì„±
        - ëƒ‰ë°© ì‹œìŠ¤í…œ, ë‹¨ì—´, ê±´ë¬¼ ì—°ì‹, ë…¸ì¶œëœ ì™¸ë²½ ë©´ì  ë“±
        """
        building = exposure['building']
        age = building['building_age']
        structure = building['structure']

        # ì·¨ì•½ì„± ì ìˆ˜ ê³„ì‚° (0-100, ë†’ì„ìˆ˜ë¡ ì·¨ì•½)
        score = 50  # ê¸°ë³¸ê°’

        # ê±´ë¬¼ ì—°ì‹ (ì˜¤ë˜ë ìˆ˜ë¡ ì·¨ì•½)
        if age > 30:
            score += 20
        elif age > 20:
            score += 10

        # êµ¬ì¡° (ë‹¨ì—´ ì„±ëŠ¥)
        if 'ëª©ì¡°' in structure or 'ë²½ëŒ' in structure:
            score += 15  # ë‹¨ì—´ ì·¨ì•½
        elif 'ì² ê·¼ì½˜í¬ë¦¬íŠ¸' in structure:
            score -= 10  # ë‹¨ì—´ ì–‘í˜¸

        # ìš©ë„ (ëƒ‰ë°© í•„ìš”ì„±)
        if building['main_purpose'] in ['ì—…ë¬´ì‹œì„¤', 'ìƒì—…ì‹œì„¤']:
            score += 10  # ëƒ‰ë°© ë¶€í•˜ ë†’ìŒ

        # 0-100 ë²”ìœ„ë¡œ ì •ê·œí™”
        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'building_age': age,
                'insulation_quality': 'poor' if age > 30 else 'fair',
                'cooling_capacity': 'standard',
                'heat_resistance': 'medium',
            }
        }

    # ========================================================================
    # 2. ê·¹í•œ í•œíŒŒ (Extreme Cold) ì·¨ì•½ì„±
    # ========================================================================

    def _calculate_cold_vulnerability(self, exposure: Dict) -> Dict:
        """ê·¹í•œ í•œíŒŒ ì·¨ì•½ì„±"""
        building = exposure['building']
        age = building['building_age']

        score = 50

        if age > 30:
            score += 20  # ë…¸í›„ ê±´ë¬¼ â†’ ë‹¨ì—´ ì·¨ì•½
        elif age > 20:
            score += 10

        if 'ëª©ì¡°' in building['structure']:
            score += 15  # ëª©ì¡° â†’ í•œíŒŒ ì·¨ì•½

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'building_age': age,
                'insulation_quality': 'poor' if age > 30 else 'fair',
                'heating_system': 'standard',
                'pipe_freeze_risk': 'medium',
            }
        }

    # ========================================================================
    # 3. ê°€ë­„ (Drought) ì·¨ì•½ì„±
    # ========================================================================

    def _calculate_drought_vulnerability(self, exposure: Dict) -> Dict:
        """ê°€ë­„ ì·¨ì•½ì„±"""
        building = exposure['building']
        infra = exposure['infrastructure']

        score = 30  # ê°€ë­„ì€ ê±´ë¬¼ ì§ì ‘ í”¼í•´ ì ìŒ

        # ìš©ìˆ˜ ì˜ì¡´ë„
        if building['main_purpose'] in ['ê³µì¥', 'ìˆ™ë°•ì‹œì„¤']:
            score += 30  # ìš©ìˆ˜ ì˜ì¡´ë„ ë†’ìŒ

        # ë¹„ìƒ ê¸‰ìˆ˜
        if not infra['water_supply_available']:
            score += 20

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'water_dependency': 'medium',
                'backup_water_supply': infra['water_supply_available'],
                'water_storage_capacity': 'limited',
            }
        }

    # ========================================================================
    # 4. ë‚´ë¥™ í™ìˆ˜ (Inland Flood) ì·¨ì•½ì„±
    # ========================================================================

    def _calculate_inland_flood_vulnerability(self, exposure: Dict) -> Dict:
        """
        ë‚´ë¥™ í™ìˆ˜ ì·¨ì•½ì„±
        - ì§€í•˜ì¸µ, í•„ë¡œí‹°, ë°©ìˆ˜ ì„¤ê³„, ë°°ìˆ˜ ì‹œì„¤ ë“±
        """
        building = exposure['building']
        flood_exp = exposure['flood_exposure']

        score = 40  # ê¸°ë³¸ê°’

        # ì§€í•˜ì¸µ (ì¹¨ìˆ˜ ì‹œ í° í”¼í•´)
        if building['floors_below'] > 0:
            score += 25

        # í•„ë¡œí‹° (ì¹¨ìˆ˜ í”¼í•´ ê°ì†Œ)
        if building['has_piloti']:
            score -= 20

        # ê±´ë¬¼ ì—°ì‹ (ë°©ìˆ˜ ì„±ëŠ¥ ì €í•˜)
        if building['building_age'] > 30:
            score += 15

        # í™ìˆ˜ ìœ„í—˜ êµ¬ì—­
        if flood_exp['in_flood_zone']:
            score += 20

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'has_basement': building['floors_below'] > 0,
                'has_piloti': building['has_piloti'],
                'waterproofing': 'poor' if building['building_age'] > 30 else 'fair',
                'drainage_system': 'standard',
                'flood_barrier': False,
            }
        }

    # ========================================================================
    # 5. ë„ì‹œ í™ìˆ˜ (Urban Flood) ì·¨ì•½ì„±
    # ========================================================================

    def _calculate_urban_flood_vulnerability(self, exposure: Dict) -> Dict:
        """ë„ì‹œ í™ìˆ˜ ì·¨ì•½ì„± (ë‚´ë¥™ í™ìˆ˜ì™€ ìœ ì‚¬)"""
        building = exposure['building']

        score = 40

        if building['floors_below'] > 0:
            score += 20

        if building['has_piloti']:
            score -= 15

        if building['building_age'] > 30:
            score += 10

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'has_basement': building['floors_below'] > 0,
                'has_piloti': building['has_piloti'],
                'drainage_connection': 'standard',
                'elevation_above_street': 0,
            }
        }

    # ========================================================================
    # 6. í•´ì•ˆ í™ìˆ˜ (Coastal Flood) ì·¨ì•½ì„±
    # ========================================================================

    def _calculate_coastal_flood_vulnerability(self, exposure: Dict) -> Dict:
        """í•´ì•ˆ í™ìˆ˜ ì·¨ì•½ì„±"""
        typhoon_exp = exposure['typhoon_exposure']

        # í•´ì•ˆ ë©€ë¦¬ ë–¨ì–´ì§„ ê²½ìš° ì·¨ì•½ì„± ë‚®ìŒ
        if not typhoon_exp['coastal_exposure']:
            return {
                'score': 0,
                'level': 'very_low',
                'factors': {
                    'coastal_exposure': False,
                    'storm_surge_protection': 'not_applicable',
                }
            }

        building = exposure['building']
        score = 50

        if building['floors_below'] > 0:
            score += 20

        if building['has_piloti']:
            score -= 15

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'coastal_exposure': True,
                'storm_surge_protection': 'none',
                'seawall_nearby': False,
            }
        }

    # ========================================================================
    # 7. íƒœí’ (Typhoon) ì·¨ì•½ì„±
    # ========================================================================

    def _calculate_typhoon_vulnerability(self, exposure: Dict) -> Dict:
        """
        íƒœí’ ì·¨ì•½ì„±
        - ê±´ë¬¼ êµ¬ì¡°, ì¸µìˆ˜, ì™¸ë²½ ìƒíƒœ, ìœ ë¦¬ì°½ ë©´ì  ë“±
        """
        building = exposure['building']
        age = building['building_age']

        score = 45

        # êµ¬ì¡° (ë‚´í’ ì„±ëŠ¥)
        if 'ì² ê·¼ì½˜í¬ë¦¬íŠ¸' in building['structure'] or 'ì² ê³¨' in building['structure']:
            score -= 15  # ê°•í’ ì €í•­ ê°•í•¨
        elif 'ëª©ì¡°' in building['structure'] or 'ë²½ëŒ' in building['structure']:
            score += 20  # ê°•í’ ì·¨ì•½

        # ê±´ë¬¼ ì—°ì‹
        if age > 30:
            score += 20  # êµ¬ì¡° ë…¸í›„ â†’ ê°•í’ ì·¨ì•½

        # ê±´ë¬¼ ë†’ì´ (ê³ ì¸µ ê±´ë¬¼ â†’ ê°•í’ ë…¸ì¶œ)
        if building['floors_above'] > 10:
            score += 15

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'structural_strength': 'high' if 'ì² ê·¼ì½˜í¬ë¦¬íŠ¸' in building['structure'] else 'medium',
                'building_age': age,
                'window_area': 'medium',
                'roof_condition': 'fair',
                'wind_resistance_design': age < 20,  # ìµœê·¼ ê±´ë¬¼ì€ ë‚´í’ ì„¤ê³„
            }
        }

    # ========================================================================
    # 8. ì‚°ë¶ˆ (Wildfire) ì·¨ì•½ì„±
    # ========================================================================

    def _calculate_wildfire_vulnerability(self, exposure: Dict) -> Dict:
        """ì‚°ë¶ˆ ì·¨ì•½ì„±"""
        building = exposure['building']
        wildfire_exp = exposure['wildfire_exposure']

        score = 30

        # êµ¬ì¡° (ë‚´í™” ì„±ëŠ¥)
        if 'ëª©ì¡°' in building['structure']:
            score += 30  # ëª©ì¡° â†’ í™”ì¬ ì·¨ì•½
        elif 'ì² ê·¼ì½˜í¬ë¦¬íŠ¸' in building['structure']:
            score -= 10  # ë‚´í™” ì„±ëŠ¥ ì–‘í˜¸

        # ì‚°ë¦¼ ì¸ì ‘ì„±
        if wildfire_exp['distance_to_forest_m'] < 500:
            score += 25

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'fire_resistant_materials': 'ëª©ì¡°' not in building['structure'],
                'defensible_space': wildfire_exp['distance_to_forest_m'] > 500,
                'roof_material': 'unknown',
                'fire_suppression_system': False,
            }
        }

    # ========================================================================
    # 9. ìˆ˜ìì› ìŠ¤íŠ¸ë ˆìŠ¤ (Water Stress) ì·¨ì•½ì„±
    # ========================================================================

    def _calculate_water_stress_vulnerability(self, exposure: Dict) -> Dict:
        """ìˆ˜ìì› ìŠ¤íŠ¸ë ˆìŠ¤ ì·¨ì•½ì„±"""
        building = exposure['building']
        infra = exposure['infrastructure']

        score = 35

        # ìš©ìˆ˜ ì˜ì¡´ë„
        if building['main_purpose'] in ['ê³µì¥', 'ìˆ™ë°•ì‹œì„¤', 'ì—…ë¬´ì‹œì„¤']:
            score += 20

        # ë¹„ìƒ ê¸‰ìˆ˜
        if not infra['water_supply_available']:
            score += 25

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'water_dependency': 'high' if score > 60 else 'medium',
                'backup_supply': infra['water_supply_available'],
                'water_efficiency': 'standard',
            }
        }

    # ========================================================================
    # Helper Methods
    # ========================================================================

    def _score_to_level(self, score: float) -> str:
        """ì ìˆ˜ â†’ ë ˆë²¨ ë³€í™˜"""
        if score >= 80:
            return 'very_high'
        elif score >= 60:
            return 'high'
        elif score >= 40:
            return 'medium'
        elif score >= 20:
            return 'low'
        else:
            return 'very_low'

    def _print_summary(self, vulnerability: Dict, building: Dict):
        """ì·¨ì•½ì„± ìš”ì•½ ì¶œë ¥"""
        print(f"\nğŸ¢ ê±´ë¬¼ ê¸°ë³¸ ì •ë³´:")
        print(f"   ìš©ë„: {building['main_purpose']}")
        print(f"   êµ¬ì¡°: {building['structure']}")
        print(f"   ê±´ì¶•ì—°ë„: {building['build_year']}ë…„ (ë…¸í›„ë„: {building['building_age']}ë…„)")
        print(f"   ì¸µìˆ˜: ì§€ìƒ{building['floors_above']}ì¸µ / ì§€í•˜{building['floors_below']}ì¸µ")

        print(f"\nğŸ“Š ì·¨ì•½ì„± ì ìˆ˜ (0-100, ë†’ì„ìˆ˜ë¡ ì·¨ì•½):")
        for risk_type, vuln in vulnerability.items():
            risk_name = {
                'extreme_heat': 'ê·¹í•œ ê³ ì˜¨',
                'extreme_cold': 'ê·¹í•œ í•œíŒŒ',
                'drought': 'ê°€ë­„',
                'inland_flood': 'ë‚´ë¥™ í™ìˆ˜',
                'urban_flood': 'ë„ì‹œ í™ìˆ˜',
                'coastal_flood': 'í•´ì•ˆ í™ìˆ˜',
                'typhoon': 'íƒœí’',
                'wildfire': 'ì‚°ë¶ˆ',
                'water_stress': 'ìˆ˜ìì› ìŠ¤íŠ¸ë ˆìŠ¤',
            }[risk_type]

            level_emoji = {
                'very_low': 'âœ…',
                'low': 'ğŸŸ¢',
                'medium': 'ğŸŸ¡',
                'high': 'ğŸŸ ',
                'very_high': 'ğŸ”´',
            }[vuln['level']]

            print(f"   {level_emoji} {risk_name}: {vuln['score']:.1f} ({vuln['level']})")


if __name__ == "__main__":
    # í…ŒìŠ¤íŠ¸
    from exposure_calculator import ExposureCalculator

    exposure_calc = ExposureCalculator()
    vuln_calc = VulnerabilityCalculator()

    # í…ŒìŠ¤íŠ¸: ëŒ€ì „ ìœ ì„±
    print("\n" + "="*80)
    print("í…ŒìŠ¤íŠ¸: ëŒ€ì „ê´‘ì—­ì‹œ ìœ ì„±êµ¬ ì›ì´Œë™ 140-1")

    exposure = exposure_calc.calculate((36.38296731680909, 127.3954419423826))
    vulnerability = vuln_calc.calculate(exposure)
