//// ----------------------------------------------------
////
////    Consolidated ERD for SKAX Physical Risk AI System
////    Version: 1.3 (Final Corrected Version)
////    Date: 2025-11-19
////
////    This document merges schemas from all sources into a single, consistent ERD.
////    All relationships are defined in SECTION 5 to prevent duplication and parsing errors.
////
//// ----------------------------------------------------

//// ===================================================================================
//// SECTION 1: CORE APPLICATION SCHEMA
//// ===================================================================================

Table users {
  id uuid [pk]
  email varchar(255) [unique, not null]
  name varchar(100) [not null]
  password varchar(255) [not null]
  language varchar(10)
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp [not null, default: `now()`]
  Note: '시스템 사용자 정보 (단순화 버전)'
}

Table sites {
  id uuid [pk]
  user_id uuid [not null]
  name varchar(255) [not null]
  road_address varchar(500)
  jibun_address varchar(500)
  latitude decimal(10, 8)
  longitude decimal(11, 8)
  type varchar(100)
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp [not null, default: `now()`]
  Note: '사용자가 관리하는 개별 사업장 정보 (단순화 버전)'
}

Table industries {
  code varchar(100) [pk]
  name_ko varchar(100) [not null, note: '업종명 (한글)']
  name_en varchar(100) [note: '업종명 (영문)']
  description text
  Note: '업종 마스터 데이터'
}

Table hazard_types {
  code varchar(50) [pk]
  name_ko varchar(100) [not null, note: '재해 유형명 (한글)']
  name_en varchar(100) [note: '재해 유형명 (영문)']
  category varchar(50) [note: '재해 카테고리 (e.g., temperature, water)']
  description text
  availableMetrics json [note: '분석 가능한 지표 목록']
  Note: '분석 가능한 재해/기후 리스크 유형 마스터 데이터'
}

Table analysis_jobs {
  id uuid [pk]
  user_id uuid [not null]
  site_id uuid [not null]
  status varchar(50) [not null, default: 'pending', note: '상태 (pending, running, completed, failed)']
  progress int [note: '진행률 (0-100)']
  analysis_options json [note: '분석 요청 시 사용된 옵션 (e.g., scenarios, hazard_types)']
  currentNode varchar [note: '현재 실행 중인 Agent Node']
  currentHazard varchar [note: '현재 분석 중인 재해 유형']
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp [not null, default: `now()`]
  completed_at timestamp
  estimatedCompletionTime timestamp
  error_message text
  Note: '비동기 리스크 분석 작업의 상태를 관리하는 테이블'
}

Table reports {
  id uuid [pk]
  user_id uuid [not null]
  site_id uuid [not null]
  report_type varchar(50) [not null, note: '리포트 종류 (summary, full, governance)']
  s3_key varchar(255) [note: '생성된 리포트 파일의 S3 경로']
  status varchar(50) [not null, default: 'generating', note: '상태 (generating, completed, failed)']
  siteName varchar(255)
  fileSize int
  created_at timestamp [not null, default: `now()`]
  completed_at timestamp
  expires_at timestamp [note: '다운로드 링크 만료 기한']
  Note: '생성된 리포트의 마스터 정보 및 다운로드 경로 관리'
}

Table report_sections {
  id uuid [pk]
  report_id uuid [not null]
  section_title varchar(255) [not null, note: '섹션 제목 (e.g., 경영진 요약, 리스크 매트릭스)']
  content text [note: 'LLM이 생성한 섹션별 텍스트 내용']
  section_order int [note: '리포트 내 섹션 순서']
  charts_data json [note: '해당 섹션에 포함된 차트 데이터']
  Note: 'LLM이 생성한 리포트의 개별 섹션을 구조적으로 저장'
}

Table password_reset_tokens {
  id uuid [pk]
  user_id uuid [not null]
  token varchar(255) [unique, not null]
  expires_at timestamp [not null]
  created_at timestamp [not null, default: `now()`]
}


//// ===================================================================================
//// SECTION 2: ANALYSIS & FINANCIALS SCHEMA
//// ===================================================================================

Table physical_risk_scores {
  id uuid [pk]
  analysis_job_id uuid [not null, note: '분석 작업 ID']
  site_id uuid [not null, note: '사업장 ID']
  hazard_type varchar(50) [not null, note: '재해 유형']
  scenario varchar(20) [not null, note: 'SSP 시나리오']
  year int [not null, note: '분석 연도']
  h_score decimal(7, 4) [note: 'Hazard 점수']
  e_score decimal(7, 4) [note: 'Exposure 점수']
  v_score decimal(7, 4) [note: 'Vulnerability 점수']
  overall_score decimal(7, 4) [not null, note: '최종 리스크 종합 점수']
  risk_level varchar(20) [note: '리스크 등급 (Low, Medium, High)']
  details_json json [note: '점수 계산에 사용된 세부 데이터']
  calculated_at timestamp [not null, default: `now()`]
  indexes { (analysis_job_id, hazard_type, scenario, year) [unique] }
  Note: '계산된 최종 물리적 리스크 점수를 저장하는 통합 테이블'
}

Table site_assets {
  id uuid [pk]
  site_id uuid [not null, note: '자산이 속한 사업장']
  asset_name varchar(255) [not null, note: '자산명 (e.g., 본관 건물, 1번 생산라인)']
  asset_type varchar(100) [note: '자산 유형 (e.g., building, machinery)']
  asset_value decimal(20, 2) [not null, note: '자산 가치 (AAL 계산용)']
  currency varchar(10) [default: 'KRW']
  vulnerability_curve_json json [note: '재해 유형별 자산의 취약성 곡선 데이터']
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  Note: '사업장 내 개별 자산 정보 및 재무 가치 (AAL 계산용)'
}

Table aal_results {
  id uuid [pk]
  analysis_job_id uuid [not null]
  asset_id uuid [not null]
  hazard_type varchar(50) [not null]
  scenario varchar(20) [not null]
  aal_value decimal(20, 2) [not null, note: '연간 예상 손실액']
  aal_ratio decimal(8, 6) [note: '자산 가치 대비 연간 예상 손실률']
  prob_of_damage decimal(8, 6) [note: '연간 피해 발생 확률']
  created_at timestamp [default: `now()`]
  indexes { (analysis_job_id, asset_id, hazard_type, scenario) [unique] }
  Note: '자산별, 재해유형별, 시나리오별 AAL(연간 예상 손실) 결과'
}

Table suppliers {
  id uuid [pk]
  supplier_name varchar(255) [not null, unique]
  country_code varchar(3)
  address varchar(500)
  latitude decimal(10, 8)
  longitude decimal(11, 8)
  contact_person varchar(100)
  contact_email varchar(255)
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  Note: '공급망 리스크 분석을 위한 공급업체 정보'
}

Table site_supplier_relations {
  site_id uuid [not null]
  supplier_id uuid [not null]
  sourcing_ratio decimal(5, 2) [note: '조달 비중 (%)']
  bcp_status varchar(50) [note: 'BCP 보유 여부 (e.g., "Y", "N", "Unknown")']
  primary key (site_id, supplier_id)
  Note: '사업장과 공급업체 간의 관계 및 조달 비중'
}

Table risk_countermeasures {
  id uuid [pk]
  analysis_job_id uuid [not null]
  hazard_type varchar(50) [not null]
  strategy_description text [not null, note: '대응 전략 설명']
  action_item varchar(500) [note: '세부 실행 항목 (e.g., 방벽 설치, 냉각 시스템 교체)']
  investment_cost decimal(20, 2) [note: '예상 투자 비용']
  start_date date
  end_date date
  created_at timestamp [default: `now()`]
  Note: '식별된 리스크에 대한 사용자 정의 대응 계획 및 투자 정보'
}

//// ===================================================================================
//// SECTION 3: API & GEOSPATIAL CACHE SCHEMA
//// ===================================================================================

Table api_hospitals {
  id int [pk, increment]
  analysis_job_id uuid [note: '어떤 분석에 사용되었는지']
  duty_name varchar(255) [not null, note: '병원명']
  duty_addr varchar(500) [note: '주소']
  wgs84_lat decimal(10, 8) [not null, note: '위도']
  wgs84_lon decimal(11, 8) [not null, note: '경도']
  fetched_at timestamp [default: `now()`, note: 'API 조회 시각']
  Note: 'Vulnerability 계산용: 병원 위치 데이터 캐시'
}

Table api_buildings {
  id int [pk, increment]
  analysis_job_id uuid [note: '어떤 분석에 사용되었는지']
  sigungu_cd varchar(5) [not null]
  bjdong_cd varchar(5) [not null]
  bun varchar(10)
  ji varchar(10)
  main_purps_cd_nm varchar(100) [note: '주용도 명칭']
  strct_cd_nm varchar(100) [note: '구조 명칭']
  grnd_flr_cnt int [note: '지상층수']
  ugrnd_flr_cnt int [not null, note: '지하층수']
  use_apr_day varchar(8) [not null, note: '사용승인일자 YYYYMMDD']
  fetched_at timestamp [default: `now()`]
  Note: 'Vulnerability 계산용: 건축물대장 데이터 캐시'
}

Table api_firestations {
  id int [pk, increment]
  analysis_job_id uuid
  name varchar(255) [not null, note: '소방서명']
  address varchar(500)
  x_coord decimal(11, 8) [not null, note: '경도']
  y_coord decimal(10, 8) [not null, note: '위도']
  fetched_at timestamp [default: `now()`]
  Note: 'Vulnerability 계산용: 소방서 위치 데이터 캐시'
}

Table spatial_landcover {
  id int [pk, increment]
  analysis_job_id uuid
  site_id uuid [not null]
  buffer_m int [default: 1000]
  urban_ratio decimal(5, 4)
  agri_ratio decimal(5, 4)
  forest_ratio decimal(5, 4)
  grass_ratio decimal(5, 4)
  wetland_ratio decimal(5, 4)
  bare_ratio decimal(5, 4)
  water_ratio decimal(5, 4)
  tif_file_name varchar(255)
  analyzed_at timestamp [default: `now()`]
  Note: 'Exposure 계산용: 토지피복도 분석 결과 캐시'
}

Table spatial_dem {
  id int [pk, increment]
  analysis_job_id uuid
  site_id uuid [not null]
  buffer_m int [default: 1000]
  elevation_mean decimal(10, 2) [not null]
  elevation_min decimal(10, 2)
  elevation_max decimal(10, 2)
  slope_mean decimal(10, 2) [not null]
  dem_file_name varchar(255)
  analyzed_at timestamp [default: `now()`]
  Note: 'Exposure 계산용: DEM(수치표고모델) 분석 결과 캐시'
}


//// ===================================================================================
//// SECTION 4: CLIMATE DATA WAREHOUSE SCHEMA
//// ===================================================================================

Table scenario {
  scenario_id smallint [pk, increment, note: '시나리오 ID']
  scenario_code varchar(20) [unique, not null, note: 'SSP1-2.6, SSP2-4.5 등']
  scenario_type varchar(10) [not null, note: 'SSP']
  description text [note: '시나리오 설명']
  rcp_value numeric(4,1) [note: '2.6, 4.5, 7.0, 8.5']
  created_at timestamptz [default: `now()`]
  Note: '기후 시나리오 마스터 테이블 (4개 SSP 시나리오)'
}

Table location_admin {
  admin_id serial [pk, increment, note: '행정구역 ID']
  admin_code varchar(10) [unique, not null, note: '행정구역 코드 (11010 등)']
  admin_name varchar(100) [not null, note: '행정구역명']
  sido_code varchar(2) [note: '시도 코드']
  sigungu_code varchar(5) [note: '시군구 코드']
  level smallint [note: '행정구역 레벨 (1:시도, 2:시군구)']
  geom geometry [note: 'PostGIS MULTIPOLYGON (EPSG:5174)']
  centroid geometry [note: 'PostGIS POINT (중심점)']
  created_at timestamptz [default: `now()`]
  indexes { admin_code [name: 'idx_admin_code'] }
  Note: '행정구역 위치 정보 (약 260개)'
}

Table location_grid {
  grid_id serial [pk, increment, note: '격자점 ID']
  grid_x smallint [not null, note: '격자 X 좌표 (0~449)']
  grid_y smallint [not null, note: '격자 Y 좌표 (0~399)']
  geom geometry [note: 'PostGIS POINT (EPSG:5174)']
  lon numeric(9,6) [note: 'WGS84 경도']
  lat numeric(8,6) [note: 'WGS84 위도']
  created_at timestamptz [default: `now()`]
  indexes { (grid_x, grid_y) [unique, name: 'idx_grid_xy'] }
  Note: '격자점 위치 정보 (약 180,000개)'
}

Table variable_metadata {
  variable_code varchar(20) [pk, note: '변수 코드 (TAMAX, RN 등)']
  variable_name varchar(100) [not null, note: '변수명 (한글)']
  table_name varchar(50) [not null, note: '데이터 테이블명']
  unit varchar(20) [note: '단위 (°C, mm, m/s 등)']
  description text [note: '변수 설명']
  time_resolution varchar(10) [note: 'Daily, Monthly, Yearly']
  spatial_type varchar(10) [note: 'admin, grid']
  risk_category varchar(100) [note: '관련 리스크']
  source varchar(50) [note: '데이터 출처']
  created_at timestamptz [default: `now()`]
  Note: '변수 메타데이터 (16개 변수)'
}

Table tamax_data {
  time date [not null, note: '시간 (Daily)']
  admin_id integer [not null, note: '위치 ID']
  ssp1 real [note: 'SSP1-2.6 시나리오 값']
  ssp2 real [note: 'SSP2-4.5 시나리오 값']
  ssp3 real [note: 'SSP3-7.0 시나리오 값']
  ssp5 real [note: 'SSP5-8.5 시나리오 값']
  indexes { (time, admin_id) [pk] }
  Note: '최고기온 (Daily, admin형)'
}

Table tamin_data {
  time date [not null, note: '시간 (Daily)']
  admin_id integer [not null, note: '위치 ID']
  ssp1 real [note: 'SSP1-2.6 시나리오 값']
  ssp2 real [note: 'SSP2-4.5 시나리오 값']
  ssp3 real [note: 'SSP3-7.0 시나리오 값']
  ssp5 real [note: 'SSP5-8.5 시나리오 값']
  indexes { (time, admin_id) [pk] }
  Note: '최저기온 (Daily, admin형)'
}

Table rn_data {
  time date [not null, note: '시간 (Monthly)']
  grid_id integer [not null, note: '위치 ID']
  ssp1 real [note: 'SSP1-2.6 시나리오 값']
  ssp2 real [note: 'SSP2-4.5 시나리오 값']
  ssp3 real [note: 'SSP3-7.0 시나리오 값']
  ssp5 real [note: 'SSP5-8.5 시나리오 값']
  indexes { (time, grid_id) [pk] }
  Note: '강수량 (Monthly, grid형)'
}

Table ws_data {
  time date [not null, note: '시간 (Monthly)']
  grid_id integer [not null, note: '위치 ID']
  ssp1 real [note: 'SSP1-2.6 시나리오 값']
  ssp2 real [note: 'SSP2-4.5 시나리오 값']
  ssp3 real [note: 'SSP3-7.0 시나리오 값']
  ssp5 real [note: 'SSP5-8.5 시나리오 값']
  indexes { (time, grid_id) [pk] }
  Note: '평균풍속 (Monthly, grid형)'
}

Table ta_data {
  time date [not null, note: '시간 (Monthly)']
  grid_id integer [not null, note: '위치 ID']
  ssp1 real [note: 'SSP1-2.6 시나리오 값']
  ssp2 real [note: 'SSP2-4.5 시나리오 값']
  ssp3 real [note: 'SSP3-7.0 시나리오 값']
  ssp5 real [note: 'SSP5-8.5 시나리오 값']
  indexes { (time, grid_id) [pk] }
  Note: '평균기온 (Monthly, grid형)'
}

Table rhm_data {
  time date [not null, note: '시간 (Monthly)']
  grid_id integer [not null, note: '위치 ID']
  ssp1 real [note: 'SSP1-2.6 시나리오 값']
  ssp2 real [note: 'SSP2-4.5 시나리오 값']
  ssp3 real [note: 'SSP3-7.0 시나리오 값']
  ssp5 real [note: 'SSP5-8.5 시나리오 값']
  indexes { (time, grid_id) [pk] }
  Note: '상대습도 (Monthly, grid형)'
}

Table si_data {
  time date [not null, note: '시간 (Monthly)']
  grid_id integer [not null, note: '위치 ID']
  ssp1 real [note: 'SSP1-2.6 시나리오 값']
  ssp2 real [note: 'SSP2-4.5 시나리오 값']
  ssp3 real [note: 'SSP3-7.0 시나리오 값']
  ssp5 real [note: 'SSP5-8.5 시나리오 값']
  indexes { (time, grid_id) [pk] }
  Note: '일사량 (Monthly, grid형)'
}

Table csdi_data {
  time date [not null, note: '시간 (Yearly)']
  grid_id integer [not null, note: '위치 ID']
  ssp1 real [note: 'SSP1-2.6 시나리오 값']
  ssp2 real [note: 'SSP2-4.5 시나리오 값']
  ssp3 real [note: 'SSP3-7.0 시나리오 값']
  ssp5 real [note: 'SSP5-8.5 시나리오 값']
  indexes { (time, grid_id) [pk] }
  Note: '한랭야 계속기간 (Yearly, grid형)'
}

Table wsdi_data {
  time date [not null, note: '시간 (Yearly)']
  grid_id integer [not null, note: '위치 ID']
  ssp1 real [note: 'SSP1-2.6 시나리오 값']
  ssp2 real [note: 'SSP2-4.5 시나리오 값']
  ssp3 real [note: 'SSP3-7.0 시나리오 값']
  ssp5 real [note: 'SSP5-8.5 시나리오 값']
  indexes { (time, grid_id) [pk] }
  Note: '온난일 계속기간 (Yearly, grid형)'
}

Table rx1day_data {
  time date [not null, note: '시간 (Yearly)']
  grid_id integer [not null, note: '위치 ID']
  ssp1 real [note: 'SSP1-2.6 시나리오 값']
  ssp2 real [note: 'SSP2-4.5 시나리오 값']
  ssp3 real [note: 'SSP3-7.0 시나리오 값']
  ssp5 real [note: 'SSP5-8.5 시나리오 값']
  indexes { (time, grid_id) [pk] }
  Note: '1일 최다강수량 (Yearly, grid형)'
}

Table rain80_data {
  time date [not null, note: '시간 (Yearly)']
  grid_id integer [not null, note: '위치 ID']
  ssp1 real [note: 'SSP1-2.6 시나리오 값']
  ssp2 real [note: 'SSP2-4.5 시나리오 값']
  ssp3 real [note: 'SSP3-7.0 시나리오 값']
  ssp5 real [note: 'SSP5-8.5 시나리오 값']
  indexes { (time, grid_id) [pk] }
  Note: '호우일수 (Yearly, grid형)'
}

Table spei12_data {
  time date [not null, note: '시간 (Monthly)']
  grid_id integer [not null, note: '위치 ID']
  ssp1 real [note: 'SSP1-2.6 시나리오 값']
  ssp2 real [note: 'SSP2-4.5 시나리오 값']
  ssp3 real [note: 'SSP3-7.0 시나리오 값']
  ssp5 real [note: 'SSP5-8.5 시나리오 값']
  indexes { (time, grid_id) [pk] }
  Note: 'SPEI(12개월) (Monthly, admin형)'
}

Table rx5day_data {
  time date [not null, note: '시간 (Yearly)']
  grid_id integer [not null, note: '위치 ID']
  ssp1 real [note: 'SSP1-2.6 시나리오 값']
  ssp2 real [note: 'SSP2-4.5 시나리오 값']
  ssp3 real [note: 'SSP3-7.0 시나리오 값']
  ssp5 real [note: 'SSP5-8.5 시나리오 값']
  indexes { (time, grid_id) [pk] }
  Note: '5일최다강수량 (Yearly, grid형)'
}

Table cdd_data {
  time date [not null, note: '시간 (Yearly)']
  grid_id integer [not null, note: '위치 ID']
  ssp1 real [note: 'SSP1-2.6 시나리오 값']
  ssp2 real [note: 'SSP2-4.5 시나리오 값']
  ssp3 real [note: 'SSP3-7.0 시나리오 값']
  ssp5 real [note: 'SSP5-8.5 시나리오 값']
  indexes { (time, grid_id) [pk] }
  Note: '최대무강수 지속기간 (Yearly, grid형)'
}

Table sdii_data {
  time date [not null, note: '시간 (Yearly)']
  grid_id integer [not null, note: '위치 ID']
  ssp1 real [note: 'SSP1-2.6 시나리오 값']
  ssp2 real [note: 'SSP2-4.5 시나리오 값']
  ssp3 real [note: 'SSP3-7.0 시나리오 값']
  ssp5 real [note: 'SSP5-8.5 시나리오 값']
  indexes { (time, grid_id) [pk] }
  Note: '강수강도 (Yearly, grid형)'
}

Table sea_level_data {
  time date [not null, note: '시간 (Yearly)']
  grid_id integer [not null, note: '위치 ID']
  ssp1 real [note: 'SSP1-2.6 시나리오 값']
  ssp2 real [note: 'SSP2-4.5 시나리오 값']
  ssp3 real [note: 'SSP3-7.0 시나리오 값']
  ssp5 real [note: 'SSP5-8.5 시나리오 값']
  indexes { (time, grid_id) [pk] }
  Note: '해수면 상승 (Yearly, grid형)'
}


//// ===================================================================================
//// SECTION 5: RELATIONSHIPS
//// ===================================================================================

// --- Core Relationships ---
Ref: users.id < sites.user_id
Ref: users.id < analysis_jobs.user_id
Ref: users.id < reports.user_id
Ref: users.id < password_reset_tokens.user_id

Ref: sites.id < analysis_jobs.site_id
Ref: sites.id < reports.site_id

// --- Analysis & Financials Relationships ---
Ref: analysis_jobs.id < physical_risk_scores.analysis_job_id
Ref: sites.id < physical_risk_scores.site_id
Ref: hazard_types.code < physical_risk_scores.hazard_type

Ref: sites.id < site_assets.site_id
Ref: analysis_jobs.id < aal_results.analysis_job_id
Ref: site_assets.id < aal_results.asset_id
Ref: hazard_types.code < aal_results.hazard_type

Ref: sites.id < site_supplier_relations.site_id
Ref: suppliers.id < site_supplier_relations.supplier_id

Ref: analysis_jobs.id < risk_countermeasures.analysis_job_id
Ref: hazard_types.code < risk_countermeasures.hazard_type

// --- Report Relationships ---
Ref: reports.id < report_sections.report_id

// --- API Cache Relationships ---
Ref: analysis_jobs.id < api_hospitals.analysis_job_id
Ref: analysis_jobs.id < api_buildings.analysis_job_id
Ref: analysis_jobs.id < api_firestations.analysis_job_id
Ref: analysis_jobs.id < spatial_landcover.analysis_job_id
Ref: sites.id < spatial_landcover.site_id
Ref: analysis_jobs.id < spatial_dem.analysis_job_id
Ref: sites.id < spatial_dem.site_id

// --- SSP Data Warehouse Relationships ---
Ref: location_admin.admin_id < tamax_data.admin_id
Ref: location_admin.admin_id < tamin_data.admin_id
Ref: location_grid.grid_id < rn_data.grid_id
Ref: location_grid.grid_id < ws_data.grid_id
Ref: location_grid.grid_id < ta_data.grid_id
Ref: location_grid.grid_id < rhm_data.grid_id
Ref: location_grid.grid_id < si_data.grid_id
Ref: location_grid.grid_id < csdi_data.grid_id
Ref: location_grid.grid_id < wsdi_data.grid_id
Ref: location_grid.grid_id < rx1day_data.grid_id
Ref: location_grid.grid_id < rain80_data.grid_id
Ref: location_grid.grid_id < spei12_data.grid_id
Ref: location_grid.grid_id < rx5day_data.grid_id
Ref: location_grid.grid_id < cdd_data.grid_id
Ref: location_grid.grid_id < sdii_data.grid_id
Ref: location_grid.grid_id < sea_level_data.grid_id