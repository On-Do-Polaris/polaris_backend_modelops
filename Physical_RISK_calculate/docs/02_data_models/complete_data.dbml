////
//// ======================================================================================
//// Complete DBML for Physical Climate Risk Assessment (Full Version v2)
////
//// This file merges three distinct data models without any omissions:
//// 1. SSP Scenario Data (`ssp.dbml`)
//// 2. Local Geospatial Data (`local_data.dbml`)
//// 3. API-sourced Data (`physical_risk_api_erd.dbml`)
////
//// This version corrects the previous omission and includes all API tables.
//// ======================================================================================

Project "Complete Physical Climate Risk Assessment" {
  database_type: 'PostgreSQL'
  Note: 'Unified schema covering all local, API, and climate scenario data sources, plus analysis results.'
}


// =================================================================================
// 1. Core Location & Administrative Entities
// =================================================================================

Table admin_districts {
  admin_id integer [pk, increment, note: 'Primary key for administrative districts']
  admin_code varchar(10) [unique, not null, note: '행정구역 코드 (e.g., 11010)']
  admin_name varchar(100) [not null, note: '행정구역명']
  sido_code varchar(2)
  sigungu_code varchar(5)
  level smallint [note: 'Administrative level (1: sido, 2: sigungu)']
  geom geometry(MultiPolygon, 5179) [note: 'PostGIS MULTIPOLYGON geometry']
  
  Note: 'Master table for administrative districts.'
}

Table grid_locations {
  grid_id integer [pk, increment, note: 'Primary key for grid cells']
  grid_x smallint [not null]
  grid_y smallint [not null]
  geom geometry(Point, 5174) [note: 'PostGIS POINT geometry for the grid cell center']
  latitude decimal(9, 6) [note: 'WGS84 Latitude']
  longitude decimal(9, 6) [note: 'WGS84 Longitude']
  
  indexes {
    (grid_x, grid_y) [unique]
  }
  Note: 'Master table for grid-based locations from climate models.'
}


// =================================================================================
// 2. Local Geospatial Data
// =================================================================================

Table raster_metadata {
  raster_id integer [pk, increment]
  raster_type varchar [not null, note: 'e.g., DEM, LAND_COVER, NDVI, SOIL_MOISTURE']
  description text
  source_file text [note: 'Original file name']
  acquisition_date date
  resolution_m float
  srid integer
  postgis_table_name varchar [unique, not null, note: 'The physical PostGIS table storing the raster tiles']
  
  Note: 'Central catalog for all local raster datasets (DEM, Land Cover, etc.).'
}

Table coastline_data {
  coastline_id integer [pk, increment]
  geom geometry(MultiLineString, 4326) [not null]
  region_name varchar
  
  Note: 'Stores vector data for coastlines, loaded from a SHP file.'
}

Table rivers {
  river_id integer [pk, increment]
  geom geometry(LineString, 5179) [not null]
  river_name varchar
  stream_order integer
  
  Note: 'Vector data for rivers.'
}


// =================================================================================
// 3. API-Sourced Data - Full Set
// (From physical_risk_api_erd.dbml)
// =================================================================================

Table api_hospitals {
  hospital_id int [pk, increment]
  duty_name varchar(255) [not null]
  duty_addr varchar(500)
  wgs84_lat decimal(10, 8) [not null]
  wgs84_lon decimal(11, 8) [not null]
  geom geometry(Point, 4326) [note: 'Generated from lat/lon']
  fetched_at timestamp [default: `now()`]
  
  Note: 'Raw hospital data from the National Medical Center API.'
}

Table api_buildings {
  building_id int [pk, increment]
  sigungu_cd varchar(5) [not null]
  bjdong_cd varchar(5) [not null]
  main_purps_cd_nm varchar(100)
  strct_cd_nm varchar(100)
  grnd_flr_cnt int
  ugrnd_flr_cnt int [not null]
  use_apr_day varchar(8) [not null, note: 'YYYYMMDD format']
  fetched_at timestamp [default: `now()`]

  Note: 'Raw building register data from the Ministry of Land, Infrastructure and Transport API.'
}

Table api_firestations {
  firestation_id int [pk, increment]
  name varchar(255) [not null]
  address varchar(500)
  x_coord decimal(11, 8) [not null]
  y_coord decimal(10, 8) [not null]
  geom geometry(Point, 4326)
  fetched_at timestamp [default: `now()`]
  
  Note: 'Raw fire station data from the National Fire Agency API.'
}

Table api_wildfire_map {
  wildfire_map_id int [pk, increment]
  region_code varchar(100) [not null]
  anal_date varchar(8) [not null, note: 'YYYYMMDD']
  mean_avg decimal(5, 2) [not null, note: 'Wildfire risk index average']
  fetched_at timestamp [default: `now()`]
  
  Note: 'Raw wildfire risk map data from the Forest Service API.'
}

Table api_shelters {
  shelter_id int [pk, increment]
  shelter_name varchar(255) [not null]
  shelter_type varchar(100)
  address varchar(500)
  latitude decimal(10, 8) [not null]
  longitude decimal(11, 8) [not null]
  geom geometry(Point, 4326)
  capacity int
  fetched_at timestamp [default: `now()`]
  
  Note: 'Raw disaster shelter data from the Ministry of the Interior and Safety API.'
}

Table api_population {
  population_id int [pk, increment]
  region_code varchar(50) [not null]
  region_name varchar(100) [not null]
  total_population int [not null]
  data_year int
  fetched_at timestamp [default: `now()`]
  
  Note: 'Raw population data from the Ministry of the Interior and Safety API. Can be consolidated with admin_districts.'
}

Table api_groundwater {
  groundwater_id int [pk, increment]
  station_id varchar(50) [not null]
  station_name varchar(255)
  latitude decimal(10, 8) [not null]
  longitude decimal(11, 8) [not null]
  geom geometry(Point, 4326)
  water_level decimal(10, 2) [not null]
  measurement_date date
  fetched_at timestamp [default: `now()`]
  
  Note: 'Raw groundwater level data from the National Groundwater Information Center API.'
}

Table api_heating_facilities {
  heating_facility_id int [pk, increment]
  facility_name varchar(255) [not null]
  facility_type varchar(100)
  address varchar(500)
  latitude decimal(10, 8) [not null]
  longitude decimal(11, 8) [not null]
  geom geometry(Point, 4326)
  fetched_at timestamp [default: `now()`]
  
  Note: 'Raw data on heating facilities for cold wave response.'
}

Table api_coastal_infra {
  coastal_infra_id int [pk, increment]
  infra_type varchar(100) [not null, note: 'e.g., 방파제, 호안']
  infra_name varchar(255)
  latitude decimal(10, 8) [not null]
  longitude decimal(11, 8) [not null]
  geom geometry(Point, 4326)
  height_m decimal(10, 2) [not null]
  construction_year int
  fetched_at timestamp [default: `now()`]
  
  Note: 'Raw data on coastal defense infrastructure.'
}

Table api_water_tanks {
  water_tank_id int [pk, increment]
  tank_name varchar(255) [not null]
  tank_type varchar(100)
  address varchar(500)
  latitude decimal(10, 8) [not null]
  longitude decimal(11, 8) [not null]
  geom geometry(Point, 4326)
  capacity_ton decimal(15, 2) [not null]
  fetched_at timestamp [default: `now()`]
  
  Note: 'Raw data on water storage facilities.'
}

// =================================================================================
// 4. Climate Scenario Data (Tabular) - Full Version
// =================================================================================

Table scenario_master {
  scenario_id smallint [pk, increment]
  scenario_code varchar(20) [unique, not null, note: 'e.g., SSP1-2.6']
  description text
  
  Note: 'Master table for the 4 SSP scenarios.'
}

Table variable_metadata {
  variable_code varchar(20) [pk, note: 'e.g., TAMAX, RN']
  variable_name varchar(100) [not null]
  table_name varchar(50) [not null]
  unit varchar(20)
  description text
  
  Note: 'Metadata for each climate variable from the SSP scenarios.'
}

Table tamax_data {
  time date [not null]
  admin_id integer [not null, ref: > admin_districts.admin_id]
  ssp1 real
  ssp2 real
  ssp3 real
  ssp5 real
  
  indexes { (time, admin_id) [pk] }
  Note: 'Daily max temperature (°C) per administrative district.'
}

Table tamin_data {
  time date [not null]
  admin_id integer [not null, ref: > admin_districts.admin_id]
  ssp1 real
  ssp2 real
  ssp3 real
  ssp5 real
  
  indexes { (time, admin_id) [pk] }
  Note: 'Daily min temperature (°C) per administrative district.'
}

Table rn_data {
  time date [not null]
  grid_id integer [not null, ref: > grid_locations.grid_id]
  ssp1 real
  ssp2 real
  ssp3 real
  ssp5 real
  
  indexes { (time, grid_id) [pk] }
  Note: 'Monthly precipitation (mm) per grid cell.'
}

Table ws_data {
  time date [not null]
  grid_id integer [not null, ref: > grid_locations.grid_id]
  ssp1 real
  ssp2 real
  ssp3 real
  ssp5 real
  
  indexes { (time, grid_id) [pk] }
  Note: 'Monthly average wind speed (m/s) per grid cell.'
}

Table ta_data {
  time date [not null]
  grid_id integer [not null, ref: > grid_locations.grid_id]
  ssp1 real
  ssp2 real
  ssp3 real
  ssp5 real
  
  indexes { (time, grid_id) [pk] }
  Note: 'Monthly average temperature (°C) per grid cell.'
}

Table rhm_data {
  time date [not null]
  grid_id integer [not null, ref: > grid_locations.grid_id]
  ssp1 real
  ssp2 real
  ssp3 real
  ssp5 real
  
  indexes { (time, grid_id) [pk] }
  Note: 'Monthly relative humidity (%) per grid cell.'
}

Table si_data {
  time date [not null]
  grid_id integer [not null, ref: > grid_locations.grid_id]
  ssp1 real
  ssp2 real
  ssp3 real
  ssp5 real
  
  indexes { (time, grid_id) [pk] }
  Note: 'Monthly solar radiation per grid cell.'
}

Table csdi_data {
  time date [not null]
  grid_id integer [not null, ref: > grid_locations.grid_id]
  ssp1 real
  ssp2 real
  ssp3 real
  ssp5 real
  
  indexes { (time, grid_id) [pk] }
  Note: 'Yearly Cold Spell Duration Index (days) per grid cell.'
}

Table wsdi_data {
  time date [not null]
  grid_id integer [not null, ref: > grid_locations.grid_id]
  ssp1 real
  ssp2 real
  ssp3 real
  ssp5 real
  
  indexes { (time, grid_id) [pk] }
  Note: 'Yearly Warm Spell Duration Index (days) per grid cell.'
}

Table rx1day_data {
  time date [not null]
  grid_id integer [not null, ref: > grid_locations.grid_id]
  ssp1 real
  ssp2 real
  ssp3 real
  ssp5 real
  
  indexes { (time, grid_id) [pk] }
  Note: 'Yearly max 1-day precipitation (mm) per grid cell.'
}

Table rain80_data {
  time date [not null]
  grid_id integer [not null, ref: > grid_locations.grid_id]
  ssp1 real
  ssp2 real
  ssp3 real
  ssp5 real
  
  indexes { (time, grid_id) [pk] }
  Note: 'Yearly number of heavy rain days (>80mm) per grid cell.'
}

Table spei12_data {
  time date [not null]
  grid_id integer [not null, ref: > grid_locations.grid_id]
  ssp1 real
  ssp2 real
  ssp3 real
  ssp5 real
  
  indexes { (time, grid_id) [pk] }
  Note: 'Monthly SPEI-12 drought index per grid cell.'
}

Table rx5day_data {
  time date [not null]
  grid_id integer [not null, ref: > grid_locations.grid_id]
  ssp1 real
  ssp2 real
  ssp3 real
  ssp5 real
  
  indexes { (time, grid_id) [pk] }
  Note: 'Yearly max 5-day precipitation (mm) per grid cell.'
}

Table cdd_data {
  time date [not null]
  grid_id integer [not null, ref: > grid_locations.grid_id]
  ssp1 real
  ssp2 real
  ssp3 real
  ssp5 real
  
  indexes { (time, grid_id) [pk] }
  Note: 'Yearly max number of consecutive dry days per grid cell.'
}

Table sdii_data {
  time date [not null]
  grid_id integer [not null, ref: > grid_locations.grid_id]
  ssp1 real
  ssp2 real
  ssp3 real
  ssp5 real
  
  indexes { (time, grid_id) [pk] }
  Note: 'Yearly simple daily intensity index (mm/day) per grid cell.'
}


// =================================================================================
// 5. Analysis Results
// =================================================================================

Table climate_risk_results {
  result_id integer [pk, increment]
  latitude decimal(9, 6) [not null]
  longitude decimal(9, 6) [not null]
  
  risk_type varchar [not null, note: 'e.g., coastal_flood, drought, extreme_heat']
  ssp_scenario varchar [not null]
  target_year integer [not null]
  
  hazard_score float
  exposure_score float
  vulnerability_score float
  final_risk_score float [not null]
  
  risk_level varchar [note: 'e.g., Low, Medium, High']
  details jsonb [note: 'Stores the detailed JSON output from the calculation script']
  calculated_at timestamp [default: `now()`]
  
  indexes {
    (latitude, longitude, risk_type, ssp_scenario, target_year) [unique, name: 'unique_risk_analysis']
  }
  
  Note: 'Unified table to store the final output for all 6 types of risk analysis.'
}
