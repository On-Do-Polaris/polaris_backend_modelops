//// ----------------------------------------------------
//// Physical Risk API Data ERD (생데이터만 저장)
//// E (Exposure) & V (Vulnerability) 계산에 사용되는 API 생데이터
//// 모든 계산(거리, 나이, 비율 등)은 애플리케이션 레벨에서 수행
//// ----------------------------------------------------

// ============================================================
// 1. 병원 API (Hospital API)
// 용도: 폭염/한파 시 병원 접근성 평가 (V_hospital)
// API: 국립중앙의료원 전국 병·의원 찾기 서비스
// 사용 필드: 좌표 (거리 계산용)
// ============================================================

Table api_hospitals {
  id int [pk, increment]
  site_id uuid [not null, note: '분석 대상 사업장']
  analysis_result_id uuid [note: '분석 결과 ID (선택적)']

  // 병원 기본 정보 (API 원본 데이터)
  duty_name varchar(255) [not null, note: '병원명']
  duty_addr varchar(500) [note: '주소']
  duty_tel varchar(50) [note: '전화번호']

  // 좌표 정보 (거리 계산에 사용)
  wgs84_lat decimal(10, 8) [not null, note: '위도 (WGS84)']
  wgs84_lon decimal(11, 8) [not null, note: '경도 (WGS84)']

  // 병원 구분
  institution_type varchar(10) [note: 'B:병원, C:의원']
  department_code varchar(10) [note: '진료과목 코드']

  // 메타데이터
  fetched_at timestamp [default: `now()`, note: 'API 조회 시각']
  created_at timestamp [default: `now()`]

  Note: '폭염/한파 리스크: site 좌표와 병원 좌표로 거리 계산 → V_hospital 산출'
}

// ============================================================
// 2. 건축물 API (Building API)
// 용도: 건물 노후도, 지하층 존재 여부 평가 (V_building, V_underground)
// API: 국토교통부 건축물대장
// 사용 필드: use_apr_day (나이 계산용), ugrnd_flr_cnt (지하층 리스크)
// ============================================================

Table api_buildings {
  id int [pk, increment]
  site_id uuid [not null, note: '분석 대상 사업장']
  analysis_result_id uuid [note: '분석 결과 ID (선택적)']

  // 위치 정보 (API 조회용)
  sigungu_cd varchar(5) [not null, note: '시군구 코드']
  bjdong_cd varchar(5) [not null, note: '법정동 코드']
  plat_gb_cd varchar(1) [note: '대지구분 (0:대지, 1:산, 2:블록)']
  bun varchar(10) [note: '번']
  ji varchar(10) [note: '지']

  // 건물 기본 정보
  main_purps_cd_nm varchar(100) [note: '주용도 명칭']
  strct_cd_nm varchar(100) [note: '구조 명칭 (철근콘크리트조 등)']

  // 층수 정보 (지하층수: 산불 리스크에 사용)
  grnd_flr_cnt int [note: '지상층수']
  ugrnd_flr_cnt int [not null, note: '지하층수 (V_underground 계산용)']

  // 사용승인일자 (건물 나이 계산용: 현재연도 - 사용승인연도)
  use_apr_day varchar(8) [not null, note: '사용승인일자 YYYYMMDD (V_building 계산용)']

  // 메타데이터
  fetched_at timestamp [default: `now()`]
  created_at timestamp [default: `now()`]

  Note: '폭염/한파: (현재연도 - 사용승인연도) → V_building | 산불: ugrnd_flr_cnt → V_underground'
}

// ============================================================
// 3. 소방서 API (Firestation API)
// 용도: 산불 시 소방서 접근성 평가 (V_firestation)
// API: 공공데이터포털 소방청 API
// 사용 필드: 좌표 (거리 계산용)
// ============================================================

Table api_firestations {
  id int [pk, increment]
  site_id uuid [not null, note: '분석 대상 사업장']
  analysis_result_id uuid [note: '분석 결과 ID (선택적)']

  // 소방서 기본 정보 (API 원본 데이터)
  name varchar(255) [not null, note: '소방서 및 안전센터명']
  address varchar(500) [note: '주소']

  // 좌표 정보 (거리 계산에 사용)
  x_coord decimal(11, 8) [not null, note: 'X좌표 (경도)']
  y_coord decimal(10, 8) [not null, note: 'Y좌표 (위도)']

  // 메타데이터
  fetched_at timestamp [default: `now()`]
  created_at timestamp [default: `now()`]

  Note: '산불 리스크: site 좌표와 소방서 좌표로 거리 계산 → V_firestation 산출'
}

// ============================================================
// 4. 산불위험지도 API (Wildfire Map API)
// 용도: 산불 위험도 평가 (E_wildfire_map)
// API: 산림청 전국 산불위험지역 표준 데이터
// 사용 필드: mean_avg (산불위험지수 평균)
// ============================================================

Table api_wildfire_map {
  id int [pk, increment]
  site_id uuid [note: '분석 대상 사업장 (선택적)']
  analysis_result_id uuid [note: '분석 결과 ID (선택적)']

  // 지역 정보
  region_code varchar(100) [not null, note: '지역 코드']
  do_name varchar(100) [note: '시도 명칭']

  // 산불위험지수 (API 원본 데이터)
  anal_date varchar(8) [not null, note: '데이터 기준 일자 (YYYYMMDD)']
  maxi decimal(5, 2) [note: '산불위험예보지수 최댓값']
  mean_avg decimal(5, 2) [not null, note: '산불위험예보지수 평균 (E_wildfire_map 계산용)']

  // 메타데이터
  fetched_at timestamp [default: `now()`]
  created_at timestamp [default: `now()`]

  Note: '산불 리스크: mean_avg 값 사용 → E_wildfire_map 산출'
}

// ============================================================
// 5. 대피소 API (Shelter API)
// 용도: 재난 시 대피소 접근성 평가 (V_shelter)
// API: 행정안전부 대피소 정보
// 사용 필드: 좌표 (거리 계산용)
// ============================================================

Table api_shelters {
  id int [pk, increment]
  site_id uuid [not null, note: '분석 대상 사업장']
  analysis_result_id uuid [note: '분석 결과 ID (선택적)']

  // 대피소 기본 정보 (API 원본 데이터)
  shelter_name varchar(255) [not null, note: '대피소명']
  shelter_type varchar(100) [note: '대피소 유형 (지진, 홍수 등)']
  address varchar(500) [note: '주소']

  // 좌표 정보 (거리 계산에 사용)
  latitude decimal(10, 8) [not null, note: '위도']
  longitude decimal(11, 8) [not null, note: '경도']

  // 수용 정보
  capacity int [note: '수용 인원']
  area decimal(15, 2) [note: '면적 (㎡)']

  // 메타데이터
  fetched_at timestamp [default: `now()`]
  created_at timestamp [default: `now()`]

  Note: '재난 리스크: site 좌표와 대피소 좌표로 거리 계산 → V_shelter 산출'
}

// ============================================================
// 6. 인구 API (Population API)
// 용도: 인구밀도 기반 취약성 평가 (V_population)
// API: 행정안전부 인구통계 API
// 사용 필드: total_population (인구밀도 계산용)
// ============================================================

Table api_population {
  id int [pk, increment]
  site_id uuid [not null, note: '분석 대상 사업장']
  analysis_result_id uuid [note: '분석 결과 ID (선택적)']

  // 지역 정보
  region_code varchar(50) [not null, note: '지역 코드 (시군구 코드)']
  region_name varchar(100) [not null, note: '지역명']
  emd_code varchar(50) [note: '읍면동 코드']
  emd_name varchar(100) [note: '읍면동명']

  // 인구 정보 (API 원본 데이터)
  total_population int [not null, note: '총 인구수 (V_population 계산용)']

  // 메타데이터
  data_year int [note: '데이터 기준 연도']
  fetched_at timestamp [default: `now()`]
  created_at timestamp [default: `now()`]

  Note: '도시홍수/가뭄 리스크: total_population → V_population 산출'
}

// ============================================================
// 7. 지하수 API (Groundwater API)
// 용도: 지하수 수위 기반 가뭄 취약성 평가 (V_groundwater)
// API: 국가지하수정보센터 API
// 사용 필드: 좌표 (거리 계산), water_level (지하수위)
// ============================================================

Table api_groundwater {
  id int [pk, increment]
  site_id uuid [not null, note: '분석 대상 사업장']
  analysis_result_id uuid [note: '분석 결과 ID (선택적)']

  // 관측소 정보 (API 원본 데이터)
  station_id varchar(50) [not null, note: '관측소 ID']
  station_name varchar(255) [note: '관측소명']
  latitude decimal(10, 8) [not null, note: '관측소 위도 (거리 계산용)']
  longitude decimal(11, 8) [not null, note: '관측소 경도 (거리 계산용)']

  // 지하수 데이터
  water_level decimal(10, 2) [not null, note: '지하수위 (m) - V_groundwater 계산용']
  measurement_date date [note: '측정 일자']

  // 메타데이터
  fetched_at timestamp [default: `now()`]
  created_at timestamp [default: `now()`]

  Note: '가뭄 리스크: 가장 가까운 관측소의 water_level → V_groundwater 산출'
}

// ============================================================
// 8. 난방시설 API (Heating Facility API)
// 용도: 난방시설 접근성 기반 한파 취약성 평가 (V_heating)
// API: 공공데이터포털 난방시설 정보
// 사용 필드: 좌표 (거리 계산용)
// ============================================================

Table api_heating_facilities {
  id int [pk, increment]
  site_id uuid [not null, note: '분석 대상 사업장']
  analysis_result_id uuid [note: '분석 결과 ID (선택적)']

  // 시설 정보 (API 원본 데이터)
  facility_name varchar(255) [not null, note: '난방시설명']
  facility_type varchar(100) [note: '시설 유형 (난방텐트, 온열의자 등)']
  address varchar(500) [note: '주소']

  // 좌표 정보 (거리 계산에 사용)
  latitude decimal(10, 8) [not null, note: '위도']
  longitude decimal(11, 8) [not null, note: '경도']

  // 운영 정보
  operation_period varchar(100) [note: '운영 기간']
  capacity int [note: '수용 인원']

  // 메타데이터
  fetched_at timestamp [default: `now()`]
  created_at timestamp [default: `now()`]

  Note: '한파 리스크: site 좌표와 난방시설 좌표로 거리 계산 → V_heating 산출'
}

// ============================================================
// 9. 해안 인프라 API (Coastal Infrastructure API)
// 용도: 해안 방어시설 정보 기반 해안홍수 취약성 평가 (V_coastal_protection)
// API: 해양수산부 해안 인프라 정보
// 사용 필드: 좌표 (거리 계산), height_m (방어력)
// ============================================================

Table api_coastal_infra {
  id int [pk, increment]
  site_id uuid [not null, note: '분석 대상 사업장']
  analysis_result_id uuid [note: '분석 결과 ID (선택적)']

  // 인프라 정보 (API 원본 데이터)
  infra_type varchar(100) [not null, note: '인프라 유형 (방파제, 호안, 방조제 등)']
  infra_name varchar(255) [note: '인프라명']
  location varchar(500) [note: '위치']

  // 좌표 정보 (거리 계산에 사용)
  latitude decimal(10, 8) [not null, note: '위도']
  longitude decimal(11, 8) [not null, note: '경도']

  // 구조 정보 (방어력 계산에 사용)
  height_m decimal(10, 2) [not null, note: '높이 (m) - V_coastal_protection 계산용']
  length_m decimal(10, 2) [note: '길이 (m)']
  construction_year int [note: '건설 연도']

  // 상태 정보
  condition_status varchar(50) [note: '상태 (양호, 보통, 불량)']
  last_inspection_date date [note: '최근 점검 일자']

  // 메타데이터
  fetched_at timestamp [default: `now()`]
  created_at timestamp [default: `now()`]

  Note: '해안홍수 리스크: 가장 가까운 인프라의 height_m → V_coastal_protection 산출'
}

// ============================================================
// 10. 물탱크/저수시설 API (Water Tank API)
// 용도: 물 저장시설 정보 기반 가뭄/홍수 취약성 평가 (V_water_storage)
// API: 공공데이터포털 물탱크 정보
// 사용 필드: 좌표 (거리 계산), capacity_ton (저장 능력)
// ============================================================

Table api_water_tanks {
  id int [pk, increment]
  site_id uuid [not null, note: '분석 대상 사업장']
  analysis_result_id uuid [note: '분석 결과 ID (선택적)']

  // 시설 정보 (API 원본 데이터)
  tank_name varchar(255) [not null, note: '물탱크/저수시설명']
  tank_type varchar(100) [note: '시설 유형 (물탱크, 저수지, 저류조 등)']
  address varchar(500) [note: '주소']

  // 좌표 정보 (거리 계산에 사용)
  latitude decimal(10, 8) [not null, note: '위도']
  longitude decimal(11, 8) [not null, note: '경도']

  // 용량 정보 (저장 능력 계산에 사용)
  capacity_ton decimal(15, 2) [not null, note: '용량 (톤) - V_water_storage 계산용']
  current_level decimal(5, 2) [note: '현재 저수율 (%)']

  // 메타데이터
  fetched_at timestamp [default: `now()`]
  created_at timestamp [default: `now()`]

  Note: '가뭄 리스크: 가장 가까운 시설의 capacity_ton → V_water_storage 산출'
}

// ============================================================
// 11. 토지피복 데이터 (Spatial Land Cover)
// 용도: 환경 노출도 평가 (E)
// 데이터: 환경부 토지피복지도 (TIF 파일)
// 사용 필드: 7가지 기본 토지피복 비율 (생데이터)
// ============================================================

Table spatial_landcover {
  id int [pk, increment]
  site_id uuid [not null, note: '분석 대상 사업장']
  analysis_result_id uuid [note: '분석 결과 ID (선택적)']

  // 위치 정보
  latitude decimal(10, 8) [not null, note: '중심 위도']
  longitude decimal(11, 8) [not null, note: '중심 경도']
  buffer_m int [default: 1000, note: '버퍼 반경 (m)']

  // 토지피복 비율 (0~1) - TIF에서 추출한 생데이터
  urban_ratio decimal(5, 4) [note: '시가화건조지역 비율']
  agri_ratio decimal(5, 4) [note: '농업지역 비율']
  forest_ratio decimal(5, 4) [note: '산림지역 비율']
  grass_ratio decimal(5, 4) [note: '초지 비율']
  wetland_ratio decimal(5, 4) [note: '습지 비율']
  bare_ratio decimal(5, 4) [note: '나지 비율']
  water_ratio decimal(5, 4) [note: '수역 비율']

  // 메타데이터
  tif_file_name varchar(255) [note: '사용된 TIF 파일명']
  analyzed_at timestamp [default: `now()`]
  created_at timestamp [default: `now()`]

  Note: '폭염: urban_ratio (불투수면), 한파: bare_ratio+grass_ratio (개방지), 산불: forest_ratio → E 산출'
}

// ============================================================
// 12. DEM 데이터 (Digital Elevation Model)
// 용도: 고도/경사도 기반 노출도 평가 (E)
// 데이터: 국토지리정보원 수치표고모형 (DEM TIF 파일)
// 사용 필드: elevation_mean, slope_mean (통계 요약값 = 생데이터)
// ============================================================

Table spatial_dem {
  id int [pk, increment]
  site_id uuid [not null, note: '분석 대상 사업장']
  analysis_result_id uuid [note: '분석 결과 ID (선택적)']

  // 위치 정보
  latitude decimal(10, 8) [not null, note: '중심 위도']
  longitude decimal(11, 8) [not null, note: '중심 경도']
  buffer_m int [default: 1000, note: '버퍼 반경 (m)']

  // 고도 통계 (m) - DEM TIF에서 추출한 생데이터
  elevation_mean decimal(10, 2) [not null, note: '평균 고도 (E 계산용)']
  elevation_min decimal(10, 2) [note: '최소 고도']
  elevation_max decimal(10, 2) [note: '최대 고도']
  elevation_std decimal(10, 2) [note: '고도 표준편차']

  // 경사도 통계 (도) - DEM TIF에서 추출한 생데이터
  slope_mean decimal(10, 2) [not null, note: '평균 경사도 (E 계산용)']
  slope_min decimal(10, 2) [note: '최소 경사도']
  slope_max decimal(10, 2) [note: '최대 경사도']
  slope_std decimal(10, 2) [note: '경사도 표준편차']

  // 메타데이터
  dem_file_name varchar(255) [note: '사용된 DEM 파일명']
  analyzed_at timestamp [default: `now()`]
  created_at timestamp [default: `now()`]

  Note: '폭염: elevation_mean (저지대 취약), 한파: elevation_mean (고지대 취약), 산불: slope_mean → E 산출'
}

// ============================================================
// 13. 리스크 계산 캐시 테이블
// 용도: 생데이터 기반 계산 결과 캐싱 (H×E×V)
// ============================================================

Table risk_calculation_cache {
  id int [pk, increment]
  site_id uuid [not null, note: '분석 대상 사업장']
  hazard_type varchar(50) [not null, note: '재난 유형 (extreme_heat, extreme_cold, wildfire 등)']
  scenario varchar(50) [note: 'SSP 시나리오 (SSP126, SSP245 등)']
  year int [note: '분석 연도']

  // H (Hazard) 계산 결과
  h_norm decimal(5, 4) [note: 'H (Hazard) 정규화 값']
  h_raw_value decimal(10, 4) [note: 'H 원시값']
  h_source varchar(50) [note: 'H 데이터 출처 (netcdf, hardcoded 등)']

  // E (Exposure) 계산 결과
  e_norm decimal(5, 4) [note: 'E (Exposure) 정규화 값']
  e_components json [note: 'E 구성 요소별 계산값 (JSON)']

  // V (Vulnerability) 계산 결과
  v_norm decimal(5, 4) [note: 'V (Vulnerability) 정규화 값']
  v_components json [note: 'V 구성 요소별 계산값 (JSON)']

  // 최종 리스크 계산 결과
  risk_score decimal(5, 4) [note: '최종 리스크 점수']
  risk_level varchar(20) [note: '리스크 등급 (Low, Medium, High, Very High)']

  // 캐시 메타데이터
  is_valid boolean [default: true, note: '캐시 유효성']
  expires_at timestamp [note: '캐시 만료 시각']
  calculated_at timestamp [default: `now()`, note: '계산 시각']
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]

  indexes {
    (site_id, hazard_type, scenario, year) [unique, note: '중복 계산 방지']
  }

  Note: '생데이터 기반으로 계산된 H, E, V 및 최종 리스크 결과 캐싱'
}

// ============================================================
// Relationships (기존 ERD와 연결)
// ============================================================

// Note: 아래는 메인 ERD의 테이블과 연결하는 관계입니다
// 실제 구현 시 sites, analysis_results 테이블이 존재해야 합니다

// Ref: sites.id < api_hospitals.site_id
// Ref: sites.id < api_buildings.site_id
// Ref: sites.id < api_firestations.site_id
// Ref: sites.id < api_wildfire_map.site_id
// Ref: sites.id < api_shelters.site_id
// Ref: sites.id < spatial_landcover.site_id
// Ref: sites.id < spatial_dem.site_id
// Ref: sites.id < risk_calculation_cache.site_id

// Ref: analysis_results.id < api_hospitals.analysis_result_id
// Ref: analysis_results.id < api_buildings.analysis_result_id
// Ref: analysis_results.id < api_firestations.analysis_result_id
// Ref: analysis_results.id < api_wildfire_map.analysis_result_id
// Ref: analysis_results.id < api_shelters.analysis_result_id
// Ref: analysis_results.id < spatial_landcover.analysis_result_id
// Ref: analysis_results.id < spatial_dem.analysis_result_id

// ============================================================
// 테이블 설계 원칙 (생데이터만 저장)
// ============================================================

// 1. **순수 생데이터만 저장**: 계산값(거리, 나이, 비율 등) 제외
// 2. **로직에 사용되는 필드만 저장**: 리스크 계산에 필요한 핵심 필드만
// 3. **모든 계산은 애플리케이션 레벨에서 수행**:
//    - 거리 계산: 사업장 좌표 ↔ 시설 좌표
//    - 나이 계산: 현재연도 - 사용승인연도
//    - 비율 계산: urban_ratio → 불투수면, forest_ratio → 녹지
// 4. **계산 결과는 risk_calculation_cache에 저장**: H, E, V, Risk Score
// 5. **각 테이블은 site_id로 사업장과 연결**
// 6. **analysis_result_id는 선택적**: 분석 결과와 직접 연결 시 사용

// ============================================================
// 사용 예시 (애플리케이션 로직)
// ============================================================

// 예시 1: 폭염 리스크 계산
// 1. api_hospitals에서 좌표 조회 → 사업장과 거리 계산 → V_hospital
// 2. api_buildings에서 use_apr_day 조회 → (2025 - 사용승인연도) → V_building
// 3. spatial_landcover에서 urban_ratio 조회 → E_imperv (불투수면 노출도)
// 4. spatial_dem에서 elevation_mean 조회 → E_elevation (저지대 노출도)
// 5. H × E × V 계산 → risk_calculation_cache에 저장

// 예시 2: 산불 리스크 계산
// 1. api_firestations에서 좌표 조회 → 사업장과 거리 계산 → V_firestation
// 2. api_wildfire_map에서 mean_avg 조회 → E_wildfire_map
// 3. spatial_landcover에서 forest_ratio 조회 → E_forest
// 4. spatial_dem에서 slope_mean 조회 → E_slope
// 5. api_buildings에서 ugrnd_flr_cnt 조회 → V_underground
// 6. H × E × V 계산 → risk_calculation_cache에 저장

// ============================================================
// API 테이블별 사용 변수 매핑
// ============================================================

// 폭염 리스크 (Extreme Heat):
// - H: NetCDF (prob_sigmoid)
// - E: spatial_landcover.urban_ratio, spatial_dem.elevation_mean
// - V: api_hospitals (좌표 → 거리), api_buildings.use_apr_day (→ 나이)

// 한파 리스크 (Extreme Cold):
// - H: NetCDF (prob_sigmoid)
// - E: spatial_landcover.bare_ratio + grass_ratio, spatial_dem.elevation_mean
// - V: api_hospitals (좌표 → 거리), api_buildings.use_apr_day (→ 나이)

// 산불 리스크 (Wildfire):
// - H: NetCDF (FWI prob_sigmoid)
// - E: spatial_landcover.forest_ratio, spatial_dem.slope_mean, api_wildfire_map.mean_avg
// - V: api_firestations (좌표 → 거리), api_buildings.ugrnd_flr_cnt
