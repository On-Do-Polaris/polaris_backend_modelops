================================================================================
              H, P(H), E, V, AAL 계산 시스템 데이터 흐름 정리
================================================================================

1. 시스템 개요
--------------------------------------------------------------------------------

┌─────────────────────────────────────────────────────────────────────────────┐
│                         리스크 계산 파이프라인                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  [Step 1] hazard_probability_timeseries_batch.py                            │
│           → H (Hazard Score) 계산                                           │
│           → P(H) (Probability) 계산                                         │
│                                                                             │
│  [Step 2] evaal_ondemand_api.py                                             │
│           → E (Exposure) 계산                                               │
│           → V (Vulnerability) 계산                                          │
│           → AAL (Average Annual Loss) 스케일링                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘


================================================================================
2. [Step 1] hazard_probability_timeseries_batch.py
================================================================================

파일 위치: modelops/batch/hazard_probability_timeseries_batch.py
역할: H, P(H) 계산 및 DB 저장

[2-1] 사용 함수
--------------------------------------------------------------------------------
• calculate_hazard()      : H 점수 계산
• calculate_probability() : P(H) 확률 계산
• save_hazard_results()   : hazard_results 테이블 저장
• save_probability_results(): probability_results 테이블 저장


[2-2] H (Hazard Score) 데이터 흐름
--------------------------------------------------------------------------------

    입력: (lat, lon, scenario, target_year, risk_type)
           │
           ▼
    ┌─────────────────────────────────────────────────────────────┐
    │  HazardDataCollector.collect_data()                         │
    │  위치: modelops/utils/hazard_data_collector.py              │
    ├─────────────────────────────────────────────────────────────┤
    │  내부에서 호출하는 DataLoader:                              │
    │  • ClimateDataLoader   → kma_ssp_sgg261 (기후 데이터)       │
    │  • SpatialDataLoader   → 토지피복, 표고 등                  │
    │  • BuildingDataFetcher → building_aggregate_cache           │
    │  • DisasterAPIFetcher  → api_river_info, api_typhoon 등     │
    └─────────────────────────────────────────────────────────────┘
           │
           ▼
    collected_data = {
        'climate_data': {...},
        'spatial_data': {...},
        'building_data': {...},
        'disaster_data': {...}
    }
           │
           ▼
    ┌─────────────────────────────────────────────────────────────┐
    │  HScoreAgent.calculate_hazard_score(collected_data)         │
    │  위치: modelops/agents/hazard_calculate/                    │
    ├─────────────────────────────────────────────────────────────┤
    │  9개 리스크별 Agent:                                        │
    │  • ExtremeHeatHScoreAgent                                   │
    │  • ExtremeColdHScoreAgent                                   │
    │  • DroughtHScoreAgent                                       │
    │  • RiverFloodHScoreAgent                                    │
    │  • UrbanFloodHScoreAgent                                    │
    │  • SeaLevelRiseHScoreAgent                                  │
    │  • TyphoonHScoreAgent                                       │
    │  • WildfireHScoreAgent                                      │
    │  • WaterStressHScoreAgent                                   │
    └─────────────────────────────────────────────────────────────┘
           │
           ▼
    출력: {hazard_score_100: 33.3, hazard_level: "Low", ...}
           │
           ▼
    DB 저장: hazard_results 테이블


[2-3] P(H) (Probability) 데이터 흐름
--------------------------------------------------------------------------------

    입력: (lat, lon, scenario, risk_type)
           │
           ▼
    ┌─────────────────────────────────────────────────────────────┐
    │  ProbabilityAgent.calculate(lat, lon, ssp_scenario)         │
    │  위치: modelops/agents/probability_calculate/               │
    ├─────────────────────────────────────────────────────────────┤
    │  Agent 내부에서 직접 ClimateDataLoader 호출                 │
    │  • _build_collected_data() 메서드로 데이터 변환             │
    │  • KDE(커널 밀도 추정) → bin 분류 → 확률 계산               │
    └─────────────────────────────────────────────────────────────┘
           │
           ▼
    출력: {aal: 0.015949, bin_probabilities: [...], probability_level: "Medium"}
           │
           ▼
    DB 저장: probability_results 테이블


================================================================================
3. [Step 2] evaal_ondemand_api.py
================================================================================

파일 위치: modelops/batch/evaal_ondemand_api.py
역할: E, V, AAL 계산 및 DB 저장

[3-1] 사용 함수
--------------------------------------------------------------------------------
• calculate_exposure()       : E 점수 계산
• calculate_vulnerability()  : V 점수 계산
• calculate_aal()            : AAL 스케일링
• DatabaseConnection.save_exposure_results()
• DatabaseConnection.save_vulnerability_results()
• DatabaseConnection.save_aal_scaled_results()


[3-2] E (Exposure) 데이터 흐름
--------------------------------------------------------------------------------

    입력: (lat, lon, scenario, target_year, risk_type)
           │
           ▼
    ┌─────────────────────────────────────────────────────────────┐
    │  BuildingDataFetcher.get_building_info(lat, lon)            │
    │  위치: modelops/data_loaders/building_data_fetcher.py       │
    ├─────────────────────────────────────────────────────────────┤
    │  [DB 조회 흐름]                                             │
    │  1. get_building_code_from_coords(lat, lon)                 │
    │     → location_grid에서 bjdong_cd 조회                      │
    │                                                             │
    │  2. building_aggregate_cache 테이블 조회                    │
    │     → bjdong_cd로 건물 정보 조회                            │
    │                                                             │
    │  [반환 데이터]                                              │
    │  • building_age       : 건물 연령 (년)                      │
    │  • structure_type     : 구조 타입 (철근콘크리트 등)         │
    │  • main_purpose       : 용도 (주거, 업무 등)                │
    │  • floors_above       : 지상 층수                           │
    │  • floors_below       : 지하 층수                           │
    │  • total_area         : 연면적 (m²)                         │
    │  • has_seismic_design : 내진설계 여부                       │
    │  • data_source        : "DB" (★ DB에서 가져온 값 확인)     │
    └─────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌─────────────────────────────────────────────────────────────┐
    │  ExposureAgent.calculate_exposure(collected_data)           │
    │  위치: modelops/agents/exposure_calculate/                  │
    ├─────────────────────────────────────────────────────────────┤
    │  + SpatialDataLoader (토지피복 데이터)                      │
    │  + 리스크별 노출도 계산 로직                                │
    └─────────────────────────────────────────────────────────────┘
           │
           ▼
    출력: {exposure_score: 30, building_data: {..., data_source: "DB"}}
           │
           ▼
    DB 저장: exposure_results 테이블


[3-3] V (Vulnerability) 데이터 흐름
--------------------------------------------------------------------------------

    입력: (lat, lon, risk_type, exposure_data)
           │
           │ ★ exposure_data에서 building_data 전달받음
           ▼
    ┌─────────────────────────────────────────────────────────────┐
    │  VulnerabilityAgent.calculate_vulnerability(collected_data) │
    │  위치: modelops/agents/vulnerability_calculate/             │
    ├─────────────────────────────────────────────────────────────┤
    │  [사용하는 건물 데이터]                                     │
    │  • building_age       → 건물 노후도 평가                    │
    │  • structure_type     → 구조적 취약성 평가                  │
    │  • has_seismic_design → 내진설계 가점                       │
    │  • floors_below       → 지하층 침수 취약성                  │
    │  • main_purpose       → 용도별 취약성                       │
    └─────────────────────────────────────────────────────────────┘
           │
           ▼
    출력: {vulnerability_score: 60, factors: {building_age: 34, ...}}
           │
           ▼
    DB 저장: vulnerability_results 테이블


[3-4] AAL (Average Annual Loss) 데이터 흐름
--------------------------------------------------------------------------------

    입력: (base_aal, vulnerability_score)
           │
           │ base_aal ← probability_results 테이블에서 조회
           ▼
    ┌─────────────────────────────────────────────────────────────┐
    │  AAL_Agent.scale_aal(base_aal, v_score)                     │
    │  위치: modelops/agents/aal_calculate/                       │
    ├─────────────────────────────────────────────────────────────┤
    │  [계산 로직]                                                │
    │  vulnerability_scale = 1 + (v_score - 50) / 500             │
    │  final_aal = base_aal × vulnerability_scale                 │
    │                                                             │
    │  [예시]                                                     │
    │  base_aal=0.015949, v_score=60                              │
    │  → scale = 1 + (60-50)/500 = 1.02                           │
    │  → final_aal = 0.015949 × 1.02 = 0.016268                   │
    └─────────────────────────────────────────────────────────────┘
           │
           ▼
    출력: {base_aal: 0.015949, final_aal: 0.016268, grade: "Medium"}
           │
           ▼
    DB 저장: aal_scaled_results 테이블


================================================================================
4. DB 테이블 구조
================================================================================

[입력 테이블]
--------------------------------------------------------------------------------
• kma_ssp_sgg261          : 기후 데이터 (SSP 시나리오별)
• building_aggregate_cache : 건물 집계 데이터 (★ E, V 계산의 핵심)
• location_grid           : 좌표 → 행정구역 매핑
• api_river_info          : 하천 정보
• sea_level_grid          : 해수면 상승 데이터

[출력 테이블]
--------------------------------------------------------------------------------
• hazard_results          : H 점수 (ssp126/245/370/585_score_100)
• probability_results     : P(H) 확률 (ssp126/245/370/585_aal)
• exposure_results        : E 점수 (site_id, exposure_score)
• vulnerability_results   : V 점수 (site_id, vulnerability_score)
• aal_scaled_results      : Final AAL (ssp126/245/370/585_final_aal)


================================================================================
5. 테스트 결과 (2025-12-15)
================================================================================

테스트 좌표: (37.3825, 127.122) - 경기도 성남시 분당구 서현동
시나리오: SSP245, 목표연도: 2050

[Building Data from DB - 실제 조회 확인]
--------------------------------------------------------------------------------
    building_age: 34 (fallback=25 → DB 값 사용 확인)
    floors_above: 28 (fallback=5 → DB 값 사용 확인)
    structure_type: reinforced_concrete
    data_source: DB ✓

[Step 1 결과] H, P(H) 계산
--------------------------------------------------------------------------------
    risk_type      |  H Score   |   H Level    |   P(H) AAL   |  P Level
--------------------------------------------------------------------------------
   extreme_heat    |   33.30    |     Low      |   0.015949   |   Medium
   extreme_cold    |   23.30    |     Low      |   0.001383   |  Very Low
     wildfire      |   43.17    |    Medium    |   0.000000   |  Very Low
     drought       |    5.00    |   Very Low   |   0.016202   |   Medium
   water_stress    |   20.00    |     Low      |   0.010000   |   Medium
  sea_level_rise   |    0.00    |   Very Low   |   0.020000   |    High
   river_flood     |   51.05    |    Medium    |   0.014910   |   Medium
   urban_flood     |   32.50    |     Low      |   0.081484   | Very High
     typhoon       |   52.39    |    Medium    |   0.066572   | Very High
--------------------------------------------------------------------------------

[Step 2 결과] E, V, AAL 계산
--------------------------------------------------------------------------------
    risk_type      |    E     |    V     |   Base AAL   |  Final AAL
--------------------------------------------------------------------------------
   extreme_heat    |    30    |    60    |   0.015949   |   0.016268
   extreme_cold    |    40    |    70    |   0.001383   |   0.001438
     wildfire      |    40    |    45    |   0.000000   |   0.000000
     drought       |    25    |    70    |   0.016202   |   0.016850
   water_stress    |    20    |    55    |   0.010000   |   0.010100
  sea_level_rise   |    10    |    30    |   0.020000   |   0.019200
   river_flood     |    10    |    95    |   0.014910   |   0.016252
   urban_flood     |     0    |    70    |   0.081484   |   0.084743
     typhoon       |    40    |    85    |   0.066572   |   0.071232
--------------------------------------------------------------------------------

[DB 저장 확인]
--------------------------------------------------------------------------------
hazard_results           : 9건
probability_results      : 9건
exposure_results         : 9건
vulnerability_results    : 9건
aal_scaled_results       : 9건

테스트 완료!

================================================================================
