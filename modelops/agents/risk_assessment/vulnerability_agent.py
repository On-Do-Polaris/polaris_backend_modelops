"""
Vulnerability Agent (V 계산)
9개 리스크별 취약성 계산 로직 구현
"""

from typing import Dict, Any
import logging

logger = logging.getLogger(__name__)


class VulnerabilityAgent:
    """취약성 (V) 계산 Agent - 9개 리스크별 로직"""

    def __init__(self):
        """VulnerabilityAgent 초기화"""
        self.risk_calculators = {
            'extreme_heat': self._calculate_extreme_heat_vulnerability,
            'extreme_cold': self._calculate_extreme_cold_vulnerability,
            'drought': self._calculate_drought_vulnerability,
            'river_flood': self._calculate_river_flood_vulnerability,
            'urban_flood': self._calculate_urban_flood_vulnerability,
            'sea_level_rise': self._calculate_sea_level_rise_vulnerability,
            'typhoon': self._calculate_typhoon_vulnerability,
            'wildfire': self._calculate_wildfire_vulnerability,
            'water_stress': self._calculate_water_stress_vulnerability
        }

    def calculate_vulnerability(
        self,
        risk_type: str,
        building_info: Dict[str, Any],
        infrastructure_info: Optional[Dict[str, Any]] = None
    ) -> Dict[str, Any]:
        """
        리스크별 취약성 계산

        Args:
            risk_type: 리스크 유형
            building_info: 건물 정보
            infrastructure_info: 인프라 정보 (선택)

        Returns:
            {
                'vulnerability_score': 0.0 ~ 100.0,
                'vulnerability_level': 'very_low' ~ 'very_high',
                'factors': {...}
            }
        """
        try:
            # 리스크별 계산 함수 호출
            calculator = self.risk_calculators.get(risk_type)
            if not calculator:
                logger.warning(f"알 수 없는 리스크 유형: {risk_type}")
                return self._get_default_result()

            score = calculator(building_info, infrastructure_info or {})

            # 취약성 레벨 결정
            level = self._get_vulnerability_level(score)

            return {
                'vulnerability_score': round(score, 2),
                'vulnerability_level': level,
                'factors': self._extract_factors(building_info, risk_type)
            }

        except Exception as e:
            logger.error(f"Vulnerability 계산 실패 ({risk_type}): {e}")
            return self._get_default_result()

    def _calculate_extreme_heat_vulnerability(
        self,
        building_info: Dict[str, Any],
        infrastructure_info: Dict[str, Any]
    ) -> float:
        """
        극한 고온 취약성 계산

        입력:
        - building_age: 건물 연식
        - structure: 구조 (철근콘크리트, 목조, 벽돌 등)
        - main_purpose: 주용도
        """
        score = 50.0  # 기본값

        # 건물 연식 가점
        building_age = building_info.get('building_age', 0) or 0
        if building_age > 30:
            score += 20
        elif building_age > 20:
            score += 10

        # 구조 가점/감점
        structure = building_info.get('structure', '') or ''
        if '목조' in structure or '벽돌' in structure:
            score += 15  # 단열 취약
        elif '철근콘크리트' in structure:
            score -= 10  # 단열 양호

        # 용도 가점
        main_purpose = building_info.get('main_purpose', '') or ''
        if main_purpose in ['업무시설', '상업시설']:
            score += 10  # 냉방 부하 높음

        # 0-100 범위로 정규화
        return max(0.0, min(100.0, score))

    def _calculate_extreme_cold_vulnerability(
        self,
        building_info: Dict[str, Any],
        infrastructure_info: Dict[str, Any]
    ) -> float:
        """극한 한파 취약성 계산"""
        score = 50.0

        # 건물 연식
        building_age = building_info.get('building_age', 0) or 0
        if building_age > 30:
            score += 20  # 노후 건물 → 단열 취약
        elif building_age > 20:
            score += 10

        # 목조 건물
        structure = building_info.get('structure', '') or ''
        if '목조' in structure:
            score += 15  # 목조 → 한파 취약

        return max(0.0, min(100.0, score))

    def _calculate_drought_vulnerability(
        self,
        building_info: Dict[str, Any],
        infrastructure_info: Dict[str, Any]
    ) -> float:
        """가뭄 취약성 계산"""
        score = 30.0  # 가뭄은 건물 직접 피해 적음

        # 용수 의존도
        main_purpose = building_info.get('main_purpose', '') or ''
        if main_purpose in ['공장', '숙박시설']:
            score += 30

        # 비상 급수 가능 여부
        water_supply_available = infrastructure_info.get('water_supply_available', True)
        if not water_supply_available:
            score += 20

        return max(0.0, min(100.0, score))

    def _calculate_river_flood_vulnerability(
        self,
        building_info: Dict[str, Any],
        infrastructure_info: Dict[str, Any]
    ) -> float:
        """하천 홍수 취약성 계산"""
        score = 40.0

        # 지하층 (침수 시 큰 피해)
        floors_below = building_info.get('floors_below', 0) or 0
        if floors_below > 0:
            score += 25

        # 필로티 (침수 피해 감소)
        has_piloti = infrastructure_info.get('has_piloti', False)
        if has_piloti:
            score -= 20

        # 건물 연식 (방수 성능 저하)
        building_age = building_info.get('building_age', 0) or 0
        if building_age > 30:
            score += 15

        # 홍수 위험 구역
        in_flood_zone = infrastructure_info.get('in_flood_zone', False)
        if in_flood_zone:
            score += 20

        return max(0.0, min(100.0, score))

    def _calculate_urban_flood_vulnerability(
        self,
        building_info: Dict[str, Any],
        infrastructure_info: Dict[str, Any]
    ) -> float:
        """도시 홍수 취약성 계산 (하천 홍수와 유사)"""
        score = 40.0

        # 지하층
        floors_below = building_info.get('floors_below', 0) or 0
        if floors_below > 0:
            score += 20

        # 필로티
        has_piloti = infrastructure_info.get('has_piloti', False)
        if has_piloti:
            score -= 15

        # 건물 연식
        building_age = building_info.get('building_age', 0) or 0
        if building_age > 30:
            score += 10

        return max(0.0, min(100.0, score))

    def _calculate_sea_level_rise_vulnerability(
        self,
        building_info: Dict[str, Any],
        infrastructure_info: Dict[str, Any]
    ) -> float:
        """해수면 상승 취약성 계산"""
        score = 20.0  # 해안 지역 아니면 낮은 기본값

        # 해발 고도
        elevation = infrastructure_info.get('elevation', 100) or 100  # 기본값 100m
        if elevation < 5:  # 5m 미만
            score += 40

        # 지하층
        floors_below = building_info.get('floors_below', 0) or 0
        if floors_below > 0:
            score += 30

        # 필로티
        has_piloti = infrastructure_info.get('has_piloti', False)
        if has_piloti:
            score -= 15

        return max(0.0, min(100.0, score))

    def _calculate_typhoon_vulnerability(
        self,
        building_info: Dict[str, Any],
        infrastructure_info: Dict[str, Any]
    ) -> float:
        """태풍 취약성 계산"""
        score = 50.0

        # 고층 건물
        floors_above = building_info.get('floors_above', 1) or 1
        if floors_above > 10:
            score += 20

        # 건물 연식
        building_age = building_info.get('building_age', 0) or 0
        if building_age > 30:
            score += 15

        # 내진 설계
        has_seismic_design = infrastructure_info.get('has_seismic_design', False)
        if not has_seismic_design:
            score += 20  # 내진 설계 없으면 태풍에도 취약

        return max(0.0, min(100.0, score))

    def _calculate_wildfire_vulnerability(
        self,
        building_info: Dict[str, Any],
        infrastructure_info: Dict[str, Any]
    ) -> float:
        """산불 취약성 계산"""
        score = 30.0  # 도심 지역은 낮은 기본값

        # 목조 건물
        structure = building_info.get('structure', '') or ''
        if '목조' in structure:
            score += 30  # 목조 → 화재 취약

        # 건물 연식
        building_age = building_info.get('building_age', 0) or 0
        if building_age > 30:
            score += 15

        # 소방차 진입 가능성
        fire_access = infrastructure_info.get('fire_access', True)
        if not fire_access:
            score += 20

        return max(0.0, min(100.0, score))

    def _calculate_water_stress_vulnerability(
        self,
        building_info: Dict[str, Any],
        infrastructure_info: Dict[str, Any]
    ) -> float:
        """물부족 취약성 계산 (가뭄과 유사)"""
        score = 30.0

        # 용수 의존도
        main_purpose = building_info.get('main_purpose', '') or ''
        if main_purpose in ['공장', '숙박시설', '병원']:
            score += 30

        # 비상 급수
        water_supply_available = infrastructure_info.get('water_supply_available', True)
        if not water_supply_available:
            score += 25

        return max(0.0, min(100.0, score))

    def _get_vulnerability_level(self, score: float) -> str:
        """취약성 점수 → 등급 변환"""
        if score >= 80:
            return 'very_high'
        elif score >= 60:
            return 'high'
        elif score >= 40:
            return 'medium'
        elif score >= 20:
            return 'low'
        else:
            return 'very_low'

    def _extract_factors(self, building_info: Dict[str, Any], risk_type: str) -> Dict[str, Any]:
        """취약성 요인 추출"""
        return {
            'building_age': building_info.get('building_age', 0),
            'structure': building_info.get('structure', ''),
            'main_purpose': building_info.get('main_purpose', ''),
            'floors_below': building_info.get('floors_below', 0),
            'floors_above': building_info.get('floors_above', 0),
            'risk_type': risk_type
        }

    def _get_default_result(self) -> Dict[str, Any]:
        """에러 시 기본값 반환"""
        return {
            'vulnerability_score': 50.0,
            'vulnerability_level': 'medium',
            'factors': {}
        }


# typing 모듈 import 추가
from typing import Optional
