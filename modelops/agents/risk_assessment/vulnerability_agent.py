'''
파일명: vulnerability_agent.py
설명: 취약성(Vulnerability) 계산 Agent
업데이트: VulnerabilityCalculator 로직 통합 (건물 특성 기반)
'''
from typing import Dict, Any
import logging
try:
    from modelops.config import hazard_config as config
except ImportError:
    config = None

logger = logging.getLogger(__name__)


class VulnerabilityAgent:
    """
    취약성 (Vulnerability) 계산 Agent

    역할:
    - ExposureAgent가 생성한 노출도 데이터와 건물 정보를 기반으로
    - 각 리스크 유형별 건물의 취약성을 평가
    - 0~100 점수 및 등급 산출
    """

    def __init__(self):
        pass

    def calculate_vulnerability(self, collected_data: Dict[str, Any]) -> Dict[str, Any]:
        """
        취약성 계산

        Args:
            collected_data: 수집된 데이터 딕셔너리
                - exposure_results: ExposureAgent의 계산 결과

        Returns:
            Vulnerability 데이터 딕셔너리 (각 리스크별 점수 및 요인)
        """
        # ExposureAgent의 결과 사용
        exposure = collected_data.get('exposure_results', {})
        
        if not exposure or 'building' not in exposure:
            logger.warning("Exposure data not found. Returning default vulnerability.")
            return self._get_default_vulnerability()

        if not config:
            logger.warning("Config module not loaded. Using hardcoded defaults.")
            # Config 없을 경우를 대비한 최소한의 로직 (생략 가능하나 안전을 위해)
            return self._get_default_vulnerability()

        vulnerability = {
            'extreme_heat': self._calculate_heat_vulnerability(exposure),
            'extreme_cold': self._calculate_cold_vulnerability(exposure),
            'drought': self._calculate_drought_vulnerability(exposure),
            'river_flood': self._calculate_river_flood_vulnerability(exposure),
            'urban_flood': self._calculate_urban_flood_vulnerability(exposure),
            'sea_level_rise': self._calculate_sea_level_rise_vulnerability(exposure),
            'typhoon': self._calculate_typhoon_vulnerability(exposure),
            'wildfire': self._calculate_wildfire_vulnerability(exposure),
            'water_stress': self._calculate_water_stress_vulnerability(exposure),
        }

        return vulnerability

    # --- Helper Methods ---

    def _get_age_penalty(self, age: int, penalties: Dict[str, int]) -> int:
        """건물 연식에 따라 패널티 점수를 계산합니다."""
        if not config: return 0
        age_thresholds = config.VULNERABILITY_AGE_THRESHOLDS
        if age > age_thresholds['high']:
            return penalties.get('high', 0)
        elif age > age_thresholds['medium']:
            return penalties.get('medium', 0)
        return 0

    def _score_to_level(self, score: float) -> str:
        if score >= 80: return 'very_high'
        elif score >= 60: return 'high'
        elif score >= 40: return 'medium'
        elif score >= 20: return 'low'
        else: return 'very_low'

    def _get_default_vulnerability(self) -> Dict[str, Any]:
        defaults = {
            'score': 50,
            'level': 'medium',
            'factors': {'note': 'Default value due to missing data'}
        }
        return {risk: defaults.copy() for risk in [
            'extreme_heat', 'extreme_cold', 'drought', 'river_flood', 
            'urban_flood', 'sea_level_rise', 'typhoon', 'wildfire', 'water_stress'
        ]}

    # --- Risk-specific Calculations ---

    def _calculate_heat_vulnerability(self, exposure: Dict) -> Dict:
        building = exposure['building']
        age = building['building_age']
        structure = building['structure']

        score = config.VULNERABILITY_BASE_SCORES['extreme_heat']
        score += self._get_age_penalty(age, config.VULNERABILITY_AGE_PENALTIES['heat'])

        if '목조' in structure or '벽돌' in structure:
            score += 15
        elif '철근콘크리트' in structure:
            score -= 10

        if building['main_purpose'] in ['업무시설', '상업시설']:
            score += 10

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'building_age': age,
                'insulation_quality': 'poor' if age > 30 else 'fair',
                'cooling_capacity': 'standard',
                'heat_resistance': 'medium',
            }
        }

    def _calculate_cold_vulnerability(self, exposure: Dict) -> Dict:
        building = exposure['building']
        age = building['building_age']

        score = config.VULNERABILITY_BASE_SCORES['extreme_cold']
        score += self._get_age_penalty(age, config.VULNERABILITY_AGE_PENALTIES['cold'])

        if '목조' in building['structure']:
            score += 15

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'building_age': age,
                'insulation_quality': 'poor' if age > 30 else 'fair',
                'heating_system': 'standard',
                'pipe_freeze_risk': 'medium',
            }
        }

    def _calculate_drought_vulnerability(self, exposure: Dict) -> Dict:
        building = exposure['building']
        age = building['building_age']
        basement = building['floors_below']

        score = config.VULNERABILITY_BASE_SCORES['drought']
        score += self._get_age_penalty(age, config.VULNERABILITY_AGE_PENALTIES['drought'])

        if basement > 0:
            score += 20

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'building_age': age,
                'has_basement': basement > 0,
                'soil_subsidence_risk': 'high' if basement > 0 else 'low',
                'foundation_stability': 'poor' if age > 30 else 'fair',
            }
        }

    def _calculate_river_flood_vulnerability(self, exposure: Dict) -> Dict:
        building = exposure['building']
        flood_exp = exposure['flood_exposure']

        score = config.VULNERABILITY_BASE_SCORES['river_flood']
        score += self._get_age_penalty(building['building_age'], config.VULNERABILITY_AGE_PENALTIES['river_flood'])

        elevation_above_street = 0.0
        if building['has_piloti']:
            elevation_above_street = 3.0

        if elevation_above_street < 0.5:
            score += 15

        if building['floors_below'] > 0:
            score += 25

        if building['has_piloti']:
            score -= 20

        if flood_exp['in_flood_zone']:
            score += 20

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'first_floor_elevation_m': elevation_above_street,
                'has_basement': building['floors_below'] > 0,
                'has_piloti': building['has_piloti'],
                'waterproofing': 'poor' if building['building_age'] > 30 else 'fair',
                'drainage_system': 'standard',
                'flood_barrier': False,
            }
        }

    def _calculate_urban_flood_vulnerability(self, exposure: Dict) -> Dict:
        building = exposure['building']

        score = config.VULNERABILITY_BASE_SCORES['urban_flood']
        score += self._get_age_penalty(building['building_age'], config.VULNERABILITY_AGE_PENALTIES['urban_flood'])

        if building['floors_below'] > 0:
            score += 20

        if building['has_piloti']:
            score -= 15

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'has_basement': building['floors_below'] > 0,
                'has_piloti': building['has_piloti'],
                'drainage_connection': 'standard',
                'elevation_above_street': 0,
            }
        }

    def _calculate_sea_level_rise_vulnerability(self, exposure: Dict) -> Dict:
        building = exposure['building']
        elevation_m = building.get('elevation_m', 10)

        score = config.VULNERABILITY_BASE_SCORES['sea_level_rise']
        score += self._get_age_penalty(building['building_age'], config.VULNERABILITY_AGE_PENALTIES['sea_level_rise'])

        if elevation_m < 3:
            score += 50
        elif elevation_m < 5:
            score += 30
        elif elevation_m < 10:
            score += 10
        elif elevation_m >= 10:
            score -= 20

        if building['floors_below'] > 0 and elevation_m < 5:
            score += 20
        elif building['floors_below'] > 0 and elevation_m < 10:
            score += 5

        if building['has_piloti']:
            score -= 15

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'elevation_m': elevation_m,
                'elevation_risk': 'critical' if elevation_m < 3 else 'high' if elevation_m < 5 else 'medium' if elevation_m < 10 else 'low',
                'has_basement': building['floors_below'] > 0,
                'has_piloti': building['has_piloti'],
                'building_age': building['building_age'],
                'waterproofing': 'poor' if building['building_age'] > 30 else 'fair',
                'storm_surge_protection': 'none',
            }
        }

    def _calculate_typhoon_vulnerability(self, exposure: Dict) -> Dict:
        building = exposure['building']
        age = building['building_age']

        score = config.VULNERABILITY_BASE_SCORES['typhoon']
        score += self._get_age_penalty(age, config.VULNERABILITY_AGE_PENALTIES['typhoon'])

        if '철근콘크리트' in building['structure'] or '철골' in building['structure']:
            score -= 15
        elif '목조' in building['structure'] or '벽돌' in building['structure']:
            score += 30

        if building['floors_above'] > 10:
            score += 15

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'structural_strength': 'high' if '철근콘크리트' in building['structure'] else 'medium',
                'building_age': age,
                'window_area': 'medium',
                'roof_condition': 'fair',
                'wind_resistance_design': age < 20,
            }
        }

    def _calculate_wildfire_vulnerability(self, exposure: Dict) -> Dict:
        building = exposure['building']
        age = building['building_age']

        score = config.VULNERABILITY_BASE_SCORES['wildfire']
        score += self._get_age_penalty(age, config.VULNERABILITY_AGE_PENALTIES['wildfire'])

        structure = building.get('structure', '')
        if '목조' in structure or '샌드위치' in structure:
            score += 40
        elif '철근콘크리트' in structure:
            score -= 5

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'fire_resistant_materials': '목조' not in building['structure'],
                'building_age': age,
                'roof_material': 'unknown',
                'fire_suppression_system': False,
                'maintenance_condition': 'poor' if age > 30 else 'fair',
            }
        }

    def _calculate_water_stress_vulnerability(self, exposure: Dict) -> Dict:
        building = exposure['building']
        age = building['building_age']
        ground_floors = building.get('ground_floors', building.get('floors_above', 3))
        total_area_m2 = building.get('total_area_m2', 0)
        has_water_tank_api = building.get('has_water_tank', None)
        water_tank_method = building.get('water_tank_method', 'not_available')

        score = config.VULNERABILITY_BASE_SCORES['water_stress']
        score += self._get_age_penalty(age, config.VULNERABILITY_AGE_PENALTIES['water_stress'])

        legal_requirement = (total_area_m2 >= 3000) or (ground_floors >= 6)
        water_tank_score = 0
        if has_water_tank_api is not None:
            if not has_water_tank_api:
                water_tank_score = 25
        else:
            if not legal_requirement:
                 if total_area_m2 <= 1000 and total_area_m2 > 0:
                     water_tank_score = 20
                 elif total_area_m2 == 0:
                     water_tank_score = 25
                 else:
                     water_tank_score = 10

        score += water_tank_score

        if age < 10:
            score -= 10

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'water_tank_status': 'unknown',
                'water_tank_method': water_tank_method,
                'legal_requirement_met': legal_requirement,
                'total_area_m2': total_area_m2,
                'building_age': age,
                'water_efficiency': 'high' if age < 10 else 'standard',
                'pipe_condition': 'poor' if age > 30 else 'fair',
            }
        }