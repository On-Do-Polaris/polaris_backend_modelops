"""
Base Vulnerability Agent with common utilities for all vulnerability calculations.
"""
from typing import Dict, Any, Optional
import logging

try:
    from modelops.config import hazard_config as config
except ImportError:
    config = None

try:
    from modelops.database.connection import DatabaseConnection
    _db_available = True
except ImportError:
    _db_available = False

logger = logging.getLogger(__name__)


class BaseVulnerabilityAgent:
    """
    Base class for all vulnerability calculation agents.

    Provides common utility methods that are shared across different hazard types.
    """

    def __init__(self):
        pass

    def calculate_vulnerability(self, exposure: Dict[str, Any]) -> Dict[str, Any]:
        """
        Calculate vulnerability for a specific hazard type.
        Must be implemented by child classes.

        Args:
            exposure: Exposure data dictionary

        Returns:
            Vulnerability data dictionary with score, level, and factors
        """
        raise NotImplementedError("Subclasses must implement calculate_vulnerability()")

    def _get_age_penalty(self, age: int, penalties: Dict[str, int]) -> int:
        """
        Calculate penalty score based on building age.

        Args:
            age: Building age in years
            penalties: Dictionary of age penalties (high, medium)

        Returns:
            Penalty score
        """
        if not config:
            return 0
        age_thresholds = config.VULNERABILITY_AGE_THRESHOLDS
        if age > age_thresholds['high']:
            return penalties.get('high', 0)
        elif age > age_thresholds['medium']:
            return penalties.get('medium', 0)
        return 0

    def _score_to_level(self, score: float) -> str:
        """
        Convert vulnerability score to level.

        Args:
            score: Vulnerability score (0-100)

        Returns:
            Vulnerability level (very_high/high/medium/low/very_low)
        """
        if score >= 80:
            return 'very_high'
        elif score >= 60:
            return 'high'
        elif score >= 40:
            return 'medium'
        elif score >= 20:
            return 'low'
        else:
            return 'very_low'

    def _get_default_vulnerability(self) -> Dict[str, Any]:
        """
        Get default vulnerability values.

        Returns:
            Default vulnerability dictionary
        """
        return {
            'score': 50,
            'level': 'medium',
            'factors': {'note': 'Default value due to missing data'}
        }

    def fetch_building_data_from_db(self, latitude: float, longitude: float) -> Optional[Dict[str, Any]]:
        """
        DB에서 건물 정보 조회 (vulnerability 계산용)

        Args:
            latitude: 위도 (WGS84)
            longitude: 경도 (WGS84)

        Returns:
            {
                'building_age': int,  # 건물 연식
                'ground_floors': int,  # 지상 층수
                'floors_below': int,  # 지하 층수
                'has_piloti': bool,  # 필로티 여부
                'structure_type': str,  # 구조 유형
                'total_area_m2': float,  # 연면적
                'data_source': str
            } 또는 None
        """
        if not _db_available:
            logger.warning("Database connection not available")
            return None

        try:
            return DatabaseConnection.fetch_building_data_for_vulnerability(latitude, longitude)
        except Exception as e:
            logger.error(f"Failed to fetch building data from DB: {e}")
            return None

    def _get_building_data(self, exposure: Dict[str, Any],
                          latitude: Optional[float], longitude: Optional[float]) -> Dict[str, Any]:
        """
        건물 데이터 조회 (DB 우선, exposure fallback)

        Args:
            exposure: Exposure 데이터
            latitude: 위도
            longitude: 경도

        Returns:
            건물 데이터 딕셔너리
        """
        defaults = {
            'building_age': 30,
            'ground_floors': 3,
            'floors_below': 0,
            'has_piloti': False,
            'structure_type': 'RC',
            'total_area_m2': 500,
            'main_purpose': 'residential',
            'has_seismic_design': False,
            'elevation_m': 50.0,
            'flood_capacity': 0.0,
            'data_source': 'default'
        }

        # 1. DB에서 조회 시도
        if latitude is not None and longitude is not None:
            db_result = self.fetch_building_data_from_db(latitude, longitude)
            if db_result and db_result.get('data_source') == 'database':
                return db_result

        # 2. exposure['building']에서 가져오기
        building = exposure.get('building', {})
        if building:
            defaults['building_age'] = building.get('building_age', defaults['building_age'])
            defaults['ground_floors'] = building.get('ground_floors',
                                        building.get('floors_above', defaults['ground_floors']))
            defaults['floors_below'] = building.get('floors_below', defaults['floors_below'])
            defaults['has_piloti'] = building.get('has_piloti', defaults['has_piloti'])
            defaults['structure_type'] = building.get('structure_type', defaults['structure_type'])
            defaults['total_area_m2'] = building.get('total_area_m2', defaults['total_area_m2'])
            defaults['main_purpose'] = building.get('main_purpose', defaults['main_purpose'])
            defaults['has_seismic_design'] = building.get('has_seismic_design', defaults['has_seismic_design'])
            defaults['elevation_m'] = building.get('elevation_m', defaults['elevation_m'])
            defaults['flood_capacity'] = building.get('flood_capacity', defaults['flood_capacity'])
            defaults['data_source'] = 'exposure'

        return defaults
