"""
River Flood Vulnerability Agent
Calculates vulnerability to river flooding hazards.
"""
from typing import Dict, Any
import logging
from .base_vulnerability_agent import BaseVulnerabilityAgent

try:
    from modelops.config import hazard_config as config
except ImportError:
    config = None

logger = logging.getLogger(__name__)


class RiverFloodVulnerabilityAgent(BaseVulnerabilityAgent):
    """
    River Flood Vulnerability calculation agent.

    Evaluates vulnerability to river flooding based on building age,
    basement, piloti structure, and flood zone status.
    """

    def __init__(self):
        super().__init__()

    def calculate_vulnerability(self, exposure: Dict[str, Any], **kwargs) -> Dict[str, Any]:
        """
        Calculate river flood vulnerability.

        Args:
            exposure: Exposure data (includes building and flood_exposure information)
            **kwargs: latitude, longitude for DB lookup

        Returns:
            River flood vulnerability data (score, level, factors)
        """
        if not config:
            logger.warning("Config module not loaded. Using hardcoded defaults.")
            return self._get_default_vulnerability()

        # DB에서 건물 데이터 조회 (우선) → exposure fallback
        latitude = kwargs.get('latitude')
        longitude = kwargs.get('longitude')
        building = self._get_building_data(exposure, latitude, longitude)
        flood_exp = exposure.get('flood_exposure', {})

        age = building.get('building_age', 30)
        elevation_m = building.get('elevation_m', 50.0)
        flood_capacity = building.get('flood_capacity', 0.0)
        has_seismic = building.get('has_seismic_design', False)

        # Ensure numeric values are not None
        if age is None:
            age = 30
        if elevation_m is None:
            elevation_m = 50.0
        if flood_capacity is None:
            flood_capacity = 0.0

        score = config.VULNERABILITY_BASE_SCORES['river_flood']
        score += self._get_age_penalty(age, config.VULNERABILITY_AGE_PENALTIES['river_flood'])

        # 필로티가 있으면 1층 높이 약 3m
        elevation_above_street = 3.0 if building.get('has_piloti', False) else 0.0

        if elevation_above_street < 0.5:
            score += 15

        floors_below = building.get('floors_below', 0)
        if floors_below is not None and floors_below > 0:
            score += 25

        if building.get('has_piloti', False):
            score -= 20

        if flood_exp.get('in_flood_zone', False):
            score += 20

        score = max(0, min(100, score))

        # 홍수 방어 시설 여부 (flood_capacity 기반)
        has_flood_barrier = flood_capacity > 100

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'first_floor_elevation_m': elevation_above_street,
                'elevation_m': elevation_m,
                'has_basement': building.get('floors_below', 0) > 0,
                'has_piloti': building.get('has_piloti', False),
                'building_age': age,
                'waterproofing': 'poor' if age > 30 else 'fair',
                'drainage_system': 'standard',
                'flood_barrier': has_flood_barrier,
                'flood_capacity': flood_capacity,
                'has_seismic_design': has_seismic,
            },
            'data_source': building.get('data_source', 'default')
        }
