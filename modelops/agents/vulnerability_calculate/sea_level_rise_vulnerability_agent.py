"""
Sea Level Rise Vulnerability Agent
Calculates vulnerability to sea level rise hazards.
"""
from typing import Dict, Any
import logging
from .base_vulnerability_agent import BaseVulnerabilityAgent

try:
    from modelops.config import hazard_config as config
except ImportError:
    config = None

logger = logging.getLogger(__name__)


class SeaLevelRiseVulnerabilityAgent(BaseVulnerabilityAgent):
    """
    Sea Level Rise Vulnerability calculation agent.

    Evaluates vulnerability to sea level rise based on elevation, building age,
    basement, and piloti structure.
    """

    def __init__(self):
        super().__init__()

    def calculate_vulnerability(self, exposure: Dict[str, Any], **kwargs) -> Dict[str, Any]:
        """
        Calculate sea level rise vulnerability.

        Args:
            exposure: Exposure data (includes building information)
            **kwargs: latitude, longitude for DB lookup

        Returns:
            Sea level rise vulnerability data (score, level, factors)
        """
        if not config:
            logger.warning("Config module not loaded. Using hardcoded defaults.")
            return self._get_default_vulnerability()

        # DB에서 건물 데이터 조회
        latitude = kwargs.get('latitude')
        longitude = kwargs.get('longitude')
        building = self._get_building_data(exposure, latitude, longitude)

        # elevation은 DB에서 가져옴 (DEM 기반), exposure fallback
        elevation_m = building.get('elevation_m', exposure.get('building', {}).get('elevation_m', 10))
        age = building.get('building_age', 30)
        floors_below = building.get('floors_below', 0)
        has_piloti = building.get('has_piloti', False)
        has_seismic = building.get('has_seismic_design', False)
        flood_capacity = building.get('flood_capacity', 0.0)
        ground_floors = building.get('ground_floors', 3)
        total_area_m2 = building.get('total_area_m2', 500)

        score = config.VULNERABILITY_BASE_SCORES['sea_level_rise']
        score += self._get_age_penalty(age, config.VULNERABILITY_AGE_PENALTIES['sea_level_rise'])

        if elevation_m < 3:
            score += 50
        elif elevation_m < 5:
            score += 30
        elif elevation_m < 10:
            score += 10
        elif elevation_m >= 10:
            score -= 20

        if floors_below > 0 and elevation_m < 5:
            score += 20
        elif floors_below > 0 and elevation_m < 10:
            score += 5

        if has_piloti:
            score -= 15

        # 층수 반영: 고층은 상층부로 대피 가능
        if ground_floors > 10:
            score -= 5

        # 면적 반영: 대형 건물은 방재 시설 있을 가능성
        if total_area_m2 > 100000:
            score -= 5

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'elevation_m': elevation_m,
                'elevation_risk': 'critical' if elevation_m < 3 else 'high' if elevation_m < 5 else 'medium' if elevation_m < 10 else 'low',
                'has_basement': floors_below > 0,
                'has_piloti': has_piloti,
                'building_age': age,
                'has_seismic_design': has_seismic,
                'flood_capacity': flood_capacity,
                'waterproofing': 'poor' if age > 30 else 'fair',
                'storm_surge_protection': 'none',
            },
            'data_source': building.get('data_source', 'default')
        }
