"""
Typhoon Vulnerability Agent
Calculates vulnerability to typhoon hazards.
"""
from typing import Dict, Any
import logging
from .base_vulnerability_agent import BaseVulnerabilityAgent

try:
    from modelops.config import hazard_config as config
except ImportError:
    config = None

logger = logging.getLogger(__name__)


class TyphoonVulnerabilityAgent(BaseVulnerabilityAgent):
    """
    Typhoon Vulnerability calculation agent.

    Evaluates vulnerability to typhoons based on building structure, age, and height.
    """

    def __init__(self):
        super().__init__()

    def calculate_vulnerability(self, exposure: Dict[str, Any]) -> Dict[str, Any]:
        """
        Calculate typhoon vulnerability.

        Args:
            exposure: Exposure data (includes building information)

        Returns:
            Typhoon vulnerability data (score, level, factors)
        """
        if not config:
            logger.warning("Config module not loaded. Using hardcoded defaults.")
            return self._get_default_vulnerability()

        building = exposure.get('building', {})
        age = building.get('building_age', 30)

        score = config.VULNERABILITY_BASE_SCORES['typhoon']
        score += self._get_age_penalty(age, config.VULNERABILITY_AGE_PENALTIES['typhoon'])

        structure = building.get('structure', '')
        if 'concrete' in structure or 'steel' in structure:
            score -= 15
        elif 'wood' in structure or 'brick' in structure:
            score += 30

        if building.get('floors_above', 3) > 10:
            score += 15

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'structural_strength': 'high' if 'concrete' in structure else 'medium',
                'building_age': age,
                'window_area': 'medium',
                'roof_condition': 'fair',
                'wind_resistance_design': age < 20,
            }
        }
