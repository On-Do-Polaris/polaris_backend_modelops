"""
Water Stress Vulnerability Agent
Calculates vulnerability to water stress hazards.
"""
from typing import Dict, Any
import logging
from .base_vulnerability_agent import BaseVulnerabilityAgent

try:
    from modelops.config import hazard_config as config
except ImportError:
    config = None

logger = logging.getLogger(__name__)


class WaterStressVulnerabilityAgent(BaseVulnerabilityAgent):
    """
    Water Stress Vulnerability calculation agent.

    Evaluates vulnerability to water stress based on building age,
    water tank presence, and building area.
    """

    def __init__(self):
        super().__init__()

    def calculate_vulnerability(self, exposure: Dict[str, Any], **kwargs) -> Dict[str, Any]:
        """
        Calculate water stress vulnerability.

        Args:
            exposure: Exposure data (includes building information)
            **kwargs: latitude, longitude for DB lookup

        Returns:
            Water stress vulnerability data (score, level, factors)
        """
        if not config:
            logger.warning("Config module not loaded. Using hardcoded defaults.")
            return self._get_default_vulnerability()

        # DB에서 건물 데이터 조회 (우선) → exposure fallback
        latitude = kwargs.get('latitude')
        longitude = kwargs.get('longitude')
        building = self._get_building_data(exposure, latitude, longitude)

        age = building.get('building_age', 30)
        ground_floors = building.get('ground_floors', 3)
        total_area_m2 = building.get('total_area_m2', 0)
        has_water_tank_api = exposure.get('building', {}).get('has_water_tank', None)
        water_tank_method = exposure.get('building', {}).get('water_tank_method', 'not_available')

        score = config.VULNERABILITY_BASE_SCORES['water_stress']
        score += self._get_age_penalty(age, config.VULNERABILITY_AGE_PENALTIES['water_stress'])

        # Legal requirement: area >= 3000m² or >= 6 floors
        legal_requirement = (total_area_m2 >= 3000) or (ground_floors >= 6)

        # Calculate water tank score
        water_tank_score = 0
        if has_water_tank_api is not None:
            if not has_water_tank_api:
                water_tank_score = 25
        else:
            if not legal_requirement:
                if total_area_m2 <= 1000 and total_area_m2 > 0:
                    water_tank_score = 20
                elif total_area_m2 == 0:
                    water_tank_score = 25
                else:
                    water_tank_score = 10

        score += water_tank_score

        # Newer buildings have better water efficiency
        if age < 10:
            score -= 10

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'water_tank_status': 'unknown',
                'water_tank_method': water_tank_method,
                'legal_requirement_met': legal_requirement,
                'total_area_m2': total_area_m2,
                'building_age': age,
                'ground_floors': ground_floors,
                'water_efficiency': 'high' if age < 10 else 'standard',
                'pipe_condition': 'poor' if age > 30 else 'fair',
            },
            'data_source': building.get('data_source', 'default')
        }
