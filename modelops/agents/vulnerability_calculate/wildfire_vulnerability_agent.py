"""
Wildfire Vulnerability Agent
Calculates vulnerability to wildfire hazards.
"""
from typing import Dict, Any
import logging
from .base_vulnerability_agent import BaseVulnerabilityAgent

try:
    from modelops.config import hazard_config as config
except ImportError:
    config = None

logger = logging.getLogger(__name__)


class WildfireVulnerabilityAgent(BaseVulnerabilityAgent):
    """
    Wildfire Vulnerability calculation agent.

    Evaluates vulnerability to wildfires based on building structure and age.
    """

    def __init__(self):
        super().__init__()

    def calculate_vulnerability(self, exposure: Dict[str, Any], **kwargs) -> Dict[str, Any]:
        """
        Calculate wildfire vulnerability.

        Args:
            exposure: Exposure data (includes building information)
            **kwargs: latitude, longitude for DB lookup

        Returns:
            Wildfire vulnerability data (score, level, factors)
        """
        if not config:
            logger.warning("Config module not loaded. Using hardcoded defaults.")
            return self._get_default_vulnerability()

        # DB에서 건물 데이터 조회
        latitude = kwargs.get('latitude')
        longitude = kwargs.get('longitude')
        building = self._get_building_data(exposure, latitude, longitude)

        age = building.get('building_age', 30)
        structure = building.get('structure_type', 'RC')
        has_seismic = building.get('has_seismic_design', False)
        main_purpose = building.get('main_purpose', 'residential')

        score = config.VULNERABILITY_BASE_SCORES['wildfire']
        score += self._get_age_penalty(age, config.VULNERABILITY_AGE_PENALTIES['wildfire'])

        if structure in ['wood']:
            score += 40
        elif structure in ['RC', 'steel']:
            score -= 5

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'fire_resistant_materials': structure != 'wood',
                'structure_type': structure,
                'building_age': age,
                'main_purpose': main_purpose,
                'has_seismic_design': has_seismic,
                'roof_material': 'unknown',
                'fire_suppression_system': False,
                'maintenance_condition': 'poor' if age > 30 else 'fair',
            },
            'data_source': building.get('data_source', 'default')
        }
