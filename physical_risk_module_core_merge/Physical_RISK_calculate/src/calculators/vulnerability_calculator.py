#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
Vulnerability Calculator (V)
ì·¨ì•½ì„± ê³„ì‚°: ê±´ë¬¼ì´ ì¬ë‚œì— ì–¼ë§ˆë‚˜ ì•½í•œê°€?
"""

from typing import Dict
from ..common import config


class VulnerabilityCalculator:
    """
    ì·¨ì•½ì„±(Vulnerability) ê³„ì‚°ê¸°

    ì…ë ¥: Exposure ë°ì´í„°
    ì¶œë ¥: 9ê°œ ë¦¬ìŠ¤í¬ë³„ Vulnerability ì ìˆ˜

    Vulnerability ì •ì˜:
    - ê±´ë¬¼ì˜ êµ¬ì¡°ì , ê¸°ëŠ¥ì  ì•½ì 
    - ì¬ë‚œ ë°œìƒ ì‹œ í”¼í•´ë¥¼ ì–¼ë§ˆë‚˜ ë°›ì„ ê²ƒì¸ê°€?
    - ê±´ë¬¼ ì—°ì‹, êµ¬ì¡°, ë‚´ì§„ ì„¤ê³„, ì†Œë°©ì‹œì„¤ ë“±
    """

    def calculate(self, exposure: Dict) -> Dict:
        """
        Exposure ë°ì´í„° â†’ 9ê°œ ë¦¬ìŠ¤í¬ë³„ Vulnerability

        Args:
            exposure: ExposureCalculatorì˜ ì¶œë ¥

        Returns:
            Vulnerability ì ìˆ˜ ë”•ì…”ë„ˆë¦¬
        """
        print(f"\n{'='*80}")
        print(f"[Vulnerability Calculator] ì·¨ì•½ì„± ê³„ì‚°")
        print(f"{'='*80}")

        building = exposure['building']

        # 9ê°œ ë¦¬ìŠ¤í¬ë³„ Vulnerability ê³„ì‚°
        vulnerability = {
            'extreme_heat': self._calculate_heat_vulnerability(exposure),
            'extreme_cold': self._calculate_cold_vulnerability(exposure),
            'drought': self._calculate_drought_vulnerability(exposure),
            'river_flood': self._calculate_river_flood_vulnerability(exposure),
            'urban_flood': self._calculate_urban_flood_vulnerability(exposure),
            'sea_level_rise': self._calculate_sea_level_rise_vulnerability(exposure),
            'typhoon': self._calculate_typhoon_vulnerability(exposure),
            'wildfire': self._calculate_wildfire_vulnerability(exposure),
            'water_stress': self._calculate_water_stress_vulnerability(exposure),
        }

        print(f"\nâœ… ì·¨ì•½ì„± ê³„ì‚° ì™„ë£Œ")
        self._print_summary(vulnerability, building)

        return vulnerability

    def _get_age_penalty(self, age: int, penalties: Dict[str, int]) -> int:
        """ê±´ë¬¼ ì—°ì‹ì— ë”°ë¼ íŒ¨ë„í‹° ì ìˆ˜ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤."""
        age_thresholds = config.VULNERABILITY_AGE_THRESHOLDS
        if age > age_thresholds['high']:
            return penalties.get('high', 0)
        elif age > age_thresholds['medium']:
            return penalties.get('medium', 0)
        return 0

    # ========================================================================
    # 1. ê·¹ì‹¬í•œ ê³ ì˜¨ (Extreme Heat) ì·¨ì•½ì„±
    # ========================================================================

    def _calculate_heat_vulnerability(self, exposure: Dict) -> Dict:
        """
        ê·¹ì‹¬í•œ ê³ ì˜¨ ì·¨ì•½ì„±
        - ëƒ‰ë°© ì‹œìŠ¤í…œ, ë‹¨ì—´, ê±´ë¬¼ ì—°ì‹, ë…¸ì¶œëœ ì™¸ë²½ ë©´ì  ë“±
        """
        building = exposure['building']
        age = building['building_age']
        structure = building['structure']

        score = config.VULNERABILITY_BASE_SCORES['extreme_heat']
        score += self._get_age_penalty(age, config.VULNERABILITY_AGE_PENALTIES['heat'])

        # êµ¬ì¡° (ë‹¨ì—´ ì„±ëŠ¥)
        if 'ëª©ì¡°' in structure or 'ë²½ëŒ' in structure:
            score += 15  # ë‹¨ì—´ ì·¨ì•½
        elif 'ì² ê·¼ì½˜í¬ë¦¬íŠ¸' in structure:
            score -= 10  # ë‹¨ì—´ ì–‘í˜¸

        # ìš©ë„ (ëƒ‰ë°© í•„ìš”ì„±)
        if building['main_purpose'] in ['ì—…ë¬´ì‹œì„¤', 'ìƒì—…ì‹œì„¤']:
            score += 10  # ëƒ‰ë°© ë¶€í•˜ ë†’ìŒ

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'building_age': age,
                'insulation_quality': 'poor' if age > 30 else 'fair',
                'cooling_capacity': 'standard',
                'heat_resistance': 'medium',
            }
        }

    # ========================================================================
    # 2. ê·¹ì‹¬í•œ ê·¹ì‹¬í•œ í•œíŒŒ (Extreme Cold) ì·¨ì•½ì„±
    # ========================================================================

    def _calculate_cold_vulnerability(self, exposure: Dict) -> Dict:
        """ê·¹ì‹¬í•œ ê·¹ì‹¬í•œ í•œíŒŒ ì·¨ì•½ì„±"""
        building = exposure['building']
        age = building['building_age']

        score = config.VULNERABILITY_BASE_SCORES['extreme_cold']
        score += self._get_age_penalty(age, config.VULNERABILITY_AGE_PENALTIES['cold'])

        if 'ëª©ì¡°' in building['structure']:
            score += 15  # ëª©ì¡° â†’ ê·¹ì‹¬í•œ í•œíŒŒ ì·¨ì•½

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'building_age': age,
                'insulation_quality': 'poor' if age > 30 else 'fair',
                'heating_system': 'standard',
                'pipe_freeze_risk': 'medium',
            }
        }

    # ========================================================================
    # 3. ê°€ë­„ (Drought) ì·¨ì•½ì„±
    # ========================================================================

    def _calculate_drought_vulnerability(self, exposure: Dict) -> Dict:
        """
        ê°€ë­„ ì·¨ì•½ì„± (H-E-V í”„ë ˆì„ì›Œí¬ ì¤€ìˆ˜)
        """
        building = exposure['building']
        age = building['building_age']
        basement = building['floors_below']

        score = config.VULNERABILITY_BASE_SCORES['drought']
        score += self._get_age_penalty(age, config.VULNERABILITY_AGE_PENALTIES['drought'])

        # ì§€ë°˜ ì¹¨í•˜ ì·¨ì•½ë„ (ì§€í•˜ì¸µì´ ìˆëŠ” ê±´ë¬¼ì´ ì¹¨í•˜ ìœ„í—˜ ë†’ìŒ)
        if basement > 0:
            score += 20  # ì§€í•˜ì¸µ â†’ ì§€ë°˜ ì¹¨í•˜ ì·¨ì•½

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'building_age': age,
                'has_basement': basement > 0,
                'soil_subsidence_risk': 'high' if basement > 0 else 'low',
                'foundation_stability': 'poor' if age > 30 else 'fair',
            }
        }

    # ========================================================================
    # 4. í•˜ì²œ í™ìˆ˜ (River Flood) ì·¨ì•½ì„±
    # ========================================================================

    def _calculate_river_flood_vulnerability(self, exposure: Dict) -> Dict:
        """
        í•˜ì²œ í™ìˆ˜ ì·¨ì•½ì„± (1ì¸µ ê³ ë„ ë¡œì§ ì¶”ê°€)
        """
        building = exposure['building']
        flood_exp = exposure['flood_exposure']

        score = config.VULNERABILITY_BASE_SCORES['river_flood']
        score += self._get_age_penalty(building['building_age'], config.VULNERABILITY_AGE_PENALTIES['river_flood'])

        # 1ì¸µ ê³ ë„ í‰ê°€ (í•„ë¡œí‹°ë¥¼ í”„ë¡ì‹œë¡œ ì‚¬ìš©)
        elevation_above_street = 0.0
        if building['has_piloti']:
            elevation_above_street = 3.0

        if elevation_above_street < 0.5:
            score += 15

        if building['floors_below'] > 0:
            score += 25

        if building['has_piloti']:
            score -= 20

        if flood_exp['in_flood_zone']:
            score += 20

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'first_floor_elevation_m': elevation_above_street,
                'has_basement': building['floors_below'] > 0,
                'has_piloti': building['has_piloti'],
                'waterproofing': 'poor' if building['building_age'] > 30 else 'fair',
                'drainage_system': 'standard',
                'flood_barrier': False,
            }
        }

    # ========================================================================
    # 5. ë„ì‹œ í™ìˆ˜ (Urban Flood) ì·¨ì•½ì„±
    # ========================================================================

    def _calculate_urban_flood_vulnerability(self, exposure: Dict) -> Dict:
        """ë„ì‹œ í™ìˆ˜ ì·¨ì•½ì„± (í•˜ì²œ í™ìˆ˜ì™€ ìœ ì‚¬)"""
        building = exposure['building']

        score = config.VULNERABILITY_BASE_SCORES['urban_flood']
        score += self._get_age_penalty(building['building_age'], config.VULNERABILITY_AGE_PENALTIES['urban_flood'])

        if building['floors_below'] > 0:
            score += 20

        if building['has_piloti']:
            score -= 15

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'has_basement': building['floors_below'] > 0,
                'has_piloti': building['has_piloti'],
                'drainage_connection': 'standard',
                'elevation_above_street': 0,
            }
        }

    # ========================================================================
    # 6. í•´ìˆ˜ë©´ ìƒìŠ¹ (Sea Level Rise) ì·¨ì•½ì„±
    # ========================================================================

    def _calculate_sea_level_rise_vulnerability(self, exposure: Dict) -> Dict:
        """
        í•´ìˆ˜ë©´ ìƒìŠ¹ ì·¨ì•½ì„± (H-E-V í”„ë ˆì„ì›Œí¬ ì¤€ìˆ˜ - í•´ë°œê³ ë„ ì¤‘ì‹¬)
        """
        building = exposure['building']
        elevation_m = building.get('elevation_m', 10)

        score = config.VULNERABILITY_BASE_SCORES['sea_level_rise']
        score += self._get_age_penalty(building['building_age'], config.VULNERABILITY_AGE_PENALTIES['sea_level_rise'])

        # ========== í•µì‹¬: í•´ë°œê³ ë„ í‰ê°€ (ìµœìš°ì„ ) ==========
        if elevation_m < 3:
            score += 50
        elif elevation_m < 5:
            score += 30
        elif elevation_m < 10:
            score += 10
        elif elevation_m >= 10:
            score -= 20

        # ì§€í•˜ì¸µ í˜ë„í‹° (í•´ë°œê³ ë„ ë‚®ì„ ë•Œë§Œ ê°•ë ¥ ì ìš©)
        if building['floors_below'] > 0 and elevation_m < 5:
            score += 20
        elif building['floors_below'] > 0 and elevation_m < 10:
            score += 5

        if building['has_piloti']:
            score -= 15

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'elevation_m': elevation_m,
                'elevation_risk': 'critical' if elevation_m < 3 else 'high' if elevation_m < 5 else 'medium' if elevation_m < 10 else 'low',
                'has_basement': building['floors_below'] > 0,
                'has_piloti': building['has_piloti'],
                'building_age': building['building_age'],
                'waterproofing': 'poor' if building['building_age'] > 30 else 'fair',
                'storm_surge_protection': 'none',
            }
        }

    # ========================================================================
    # 7. íƒœí’ (Typhoon) ì·¨ì•½ì„±
    # ========================================================================

    def _calculate_typhoon_vulnerability(self, exposure: Dict) -> Dict:
        """
        íƒœí’ ì·¨ì•½ì„± (logic_doc_changes.md Section 8 ê¸°ì¤€ ì—…ë°ì´íŠ¸)
        """
        building = exposure['building']
        age = building['building_age']

        score = config.VULNERABILITY_BASE_SCORES['typhoon']
        score += self._get_age_penalty(age, config.VULNERABILITY_AGE_PENALTIES['typhoon'])

        # êµ¬ì¡° (ë‚´í’ ì„±ëŠ¥)
        if 'ì² ê·¼ì½˜í¬ë¦¬íŠ¸' in building['structure'] or 'ì² ê³¨' in building['structure']:
            score -= 15
        elif 'ëª©ì¡°' in building['structure'] or 'ë²½ëŒ' in building['structure']:
            score += 30

        # ê±´ë¬¼ ë†’ì´ (ê³ ì¸µ ê±´ë¬¼ â†’ ê°•í’ ë…¸ì¶œ)
        if building['floors_above'] > 10:
            score += 15

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'structural_strength': 'high' if 'ì² ê·¼ì½˜í¬ë¦¬íŠ¸' in building['structure'] else 'medium',
                'building_age': age,
                'window_area': 'medium',
                'roof_condition': 'fair',
                'wind_resistance_design': age < 20,
            }
        }

    # ========================================================================
    # 8. ì‚°ë¶ˆ (Wildfire) ì·¨ì•½ì„±
    # ========================================================================

    def _calculate_wildfire_vulnerability(self, exposure: Dict) -> Dict:
        """
        ì‚°ë¶ˆ ì·¨ì•½ì„± (H-E-V í”„ë ˆì„ì›Œí¬ ì¤€ìˆ˜)
        """
        building = exposure['building']
        age = building['building_age']

        score = config.VULNERABILITY_BASE_SCORES['wildfire']
        score += self._get_age_penalty(age, config.VULNERABILITY_AGE_PENALTIES['wildfire'])

        # êµ¬ì¡° (ë‚´í™” ì„±ëŠ¥)
        structure = building.get('structure', '')
        if 'ëª©ì¡°' in structure or 'ìƒŒë“œìœ„ì¹˜' in structure:
            score += 40
        elif 'ì² ê·¼ì½˜í¬ë¦¬íŠ¸' in structure:
            score -= 5

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'fire_resistant_materials': 'ëª©ì¡°' not in building['structure'],
                'building_age': age,
                'roof_material': 'unknown',
                'fire_suppression_system': False,
                'maintenance_condition': 'poor' if age > 30 else 'fair',
            }
        }

    # ========================================================================
    # 9. ë¬¼ë¶€ì¡± (Water Stress) ì·¨ì•½ì„±
    # ========================================================================

    def _calculate_water_stress_vulnerability(self, exposure: Dict) -> Dict:
        """
        ìˆ˜ìì› ìŠ¤íŠ¸ë ˆìŠ¤ ì·¨ì•½ì„± (H-E-V í”„ë ˆì„ì›Œí¬ ì¤€ìˆ˜)
        """
        building = exposure['building']
        age = building['building_age']
        ground_floors = building.get('ground_floors', building.get('floors_above', 3))
        total_area_m2 = building.get('total_area_m2', 0)
        has_water_tank_api = building.get('has_water_tank', None)
        water_tank_method = building.get('water_tank_method', 'not_available')

        score = config.VULNERABILITY_BASE_SCORES['water_stress']
        score += self._get_age_penalty(age, config.VULNERABILITY_AGE_PENALTIES['water_stress'])

        # ì €ìˆ˜ì¡° ë³´ìœ  ì—¬ë¶€ íŒë‹¨ (API ë°ì´í„° ìš°ì„ , ì—†ìœ¼ë©´ ë²•ì  ê¸°ì¤€ ì¶”ì •)
        legal_requirement = (total_area_m2 >= 3000) or (ground_floors >= 6)
        water_tank_score = 0
        if has_water_tank_api is not None:
            if not has_water_tank_api:
                water_tank_score = 25
        else:
            if not legal_requirement:
                 if total_area_m2 <= 1000 and total_area_m2 > 0:
                     water_tank_score = 20
                 elif total_area_m2 == 0:
                     water_tank_score = 25
                 else: # 1000 < area < 3000
                     water_tank_score = 10

        score += water_tank_score

        # ë¬¼ íš¨ìœ¨ì„± ì„¤ë¹„ (ì‹ ì¶• ê±´ë¬¼ì¼ìˆ˜ë¡ ì ˆìˆ˜ ì„¤ë¹„ ë³´ìœ  ê°€ëŠ¥ì„± ë†’ìŒ)
        if age < 10:
            score -= 10

        score = max(0, min(100, score))

        return {
            'score': score,
            'level': self._score_to_level(score),
            'factors': {
                'water_tank_status': 'unknown',
                'water_tank_method': water_tank_method,
                'legal_requirement_met': legal_requirement,
                'total_area_m2': total_area_m2,
                'building_age': age,
                'water_efficiency': 'high' if age < 10 else 'standard',
                'pipe_condition': 'poor' if age > 30 else 'fair',
            }
        }

    # ========================================================================
    # Helper Methods
    # ========================================================================

    def _score_to_level(self, score: float) -> str:
        """ì ìˆ˜ â†’ ë ˆë²¨ ë³€í™˜"""
        if score >= 80:
            return 'very_high'
        elif score >= 60:
            return 'high'
        elif score >= 40:
            return 'medium'
        elif score >= 20:
            return 'low'
        else:
            return 'very_low'

    def _print_summary(self, vulnerability: Dict, building: Dict):
        """ì·¨ì•½ì„± ìš”ì•½ ì¶œë ¥"""
        print(f"\nğŸ¢ ê±´ë¬¼ ê¸°ë³¸ ì •ë³´:")
        print(f"   ìš©ë„: {building['main_purpose']}")
        print(f"   êµ¬ì¡°: {building['structure']}")
        print(f"   ê±´ì¶•ì—°ë„: {building['build_year']}ë…„ (ë…¸í›„ë„: {building['building_age']}ë…„)")
        print(f"   ì¸µìˆ˜: ì§€ìƒ{building['floors_above']}ì¸µ / ì§€í•˜{building['floors_below']}ì¸µ")

        print(f"\nğŸ“Š ì·¨ì•½ì„± ì ìˆ˜ (0-100, ë†’ì„ìˆ˜ë¡ ì·¨ì•½):")
        for risk_type, vuln in vulnerability.items():
            risk_name = {
                'extreme_heat': 'ê·¹ì‹¬í•œ ê³ ì˜¨',
                'extreme_cold': 'ê·¹ì‹¬í•œ ê·¹ì‹¬í•œ í•œíŒŒ',
                'drought': 'ê°€ë­„',
                'river_flood': 'í•˜ì²œ í™ìˆ˜',
                'urban_flood': 'ë„ì‹œ í™ìˆ˜',
                'sea_level_rise': 'í•´ìˆ˜ë©´ ìƒìŠ¹',
                'typhoon': 'íƒœí’',
                'wildfire': 'ì‚°ë¶ˆ',
                'water_stress': 'ë¬¼ë¶€ì¡±',
            }[risk_type]

            level_emoji = {
                'very_low': 'âœ…',
                'low': 'ğŸŸ¢',
                'medium': 'ğŸŸ¡',
                'high': 'ğŸŸ ',
                'very_high': 'ğŸ”´',
            }[vuln['level']]

            print(f"   {level_emoji} {risk_name}: {vuln['score']:.1f} ({vuln['level']})")


if __name__ == "__main__":
    # í…ŒìŠ¤íŠ¸
    from .exposure_calculator import ExposureCalculator

    exposure_calc = ExposureCalculator()
    vuln_calc = VulnerabilityCalculator()

    # í…ŒìŠ¤íŠ¸: ëŒ€ì „ ìœ ì„±
    print("\n" + "="*80)
    print("í…ŒìŠ¤íŠ¸: ëŒ€ì „ê´‘ì—­ì‹œ ìœ ì„±êµ¬ ì›ì´Œë™ 140-1")

    exposure = exposure_calc.calculate((36.38296731680909, 127.3954419423826))
    vulnerability = vuln_calc.calculate(exposure)
