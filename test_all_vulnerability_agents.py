"""
Test script for all 9 Vulnerability Agents
Compares DB data vs Mock data for each risk type
"""
import sys
import os
sys.path.insert(0, '/Users/odong-i/Desktop/SKALA/FinalProject/DB_ALL/modelops')

# Test coordinates (same as exposure tests)
TEST_LAT = 35.1595
TEST_LON = 126.8526

RISK_TYPES = [
    'extreme_heat', 'extreme_cold', 'drought',
    'river_flood', 'urban_flood', 'wildfire',
    'water_stress', 'sea_level_rise', 'typhoon'
]

def test_single_vulnerability_agent(risk_type: str):
    """Test single vulnerability agent with DB vs Mock data"""
    print(f"\n{'='*60}")
    print(f"[{risk_type.upper()}] Vulnerability Agent Test")
    print('='*60)

    # Import the agent
    agent_class = None
    try:
        if risk_type == 'extreme_heat':
            from modelops.agents.vulnerability_calculate.extreme_heat_vulnerability_agent import ExtremeHeatVulnerabilityAgent
            agent_class = ExtremeHeatVulnerabilityAgent
        elif risk_type == 'extreme_cold':
            from modelops.agents.vulnerability_calculate.extreme_cold_vulnerability_agent import ExtremeColdVulnerabilityAgent
            agent_class = ExtremeColdVulnerabilityAgent
        elif risk_type == 'drought':
            from modelops.agents.vulnerability_calculate.drought_vulnerability_agent import DroughtVulnerabilityAgent
            agent_class = DroughtVulnerabilityAgent
        elif risk_type == 'river_flood':
            from modelops.agents.vulnerability_calculate.river_flood_vulnerability_agent import RiverFloodVulnerabilityAgent
            agent_class = RiverFloodVulnerabilityAgent
        elif risk_type == 'urban_flood':
            from modelops.agents.vulnerability_calculate.urban_flood_vulnerability_agent import UrbanFloodVulnerabilityAgent
            agent_class = UrbanFloodVulnerabilityAgent
        elif risk_type == 'wildfire':
            from modelops.agents.vulnerability_calculate.wildfire_vulnerability_agent import WildfireVulnerabilityAgent
            agent_class = WildfireVulnerabilityAgent
        elif risk_type == 'water_stress':
            from modelops.agents.vulnerability_calculate.water_stress_vulnerability_agent import WaterStressVulnerabilityAgent
            agent_class = WaterStressVulnerabilityAgent
        elif risk_type == 'sea_level_rise':
            from modelops.agents.vulnerability_calculate.sea_level_rise_vulnerability_agent import SeaLevelRiseVulnerabilityAgent
            agent_class = SeaLevelRiseVulnerabilityAgent
        elif risk_type == 'typhoon':
            from modelops.agents.vulnerability_calculate.typhoon_vulnerability_agent import TyphoonVulnerabilityAgent
            agent_class = TyphoonVulnerabilityAgent
    except ImportError as e:
        print(f"  [ERROR] Import failed: {e}")
        return None

    if not agent_class:
        print(f"  [ERROR] Agent class not found")
        return None

    agent = agent_class()

    # ===== Test 1: With DB Building Data (simulated from Exposure) =====
    print("\n[1] DB Data Test (via exposure['building'])")

    # Simulated DB data (as collected by ExposureDataCollector)
    db_building_data = {
        'building_age': 22,
        'main_purpose': '단독주택',
        'ground_floors': 2,
        'floors_below': 0,
        'has_piloti': False,
        'structure_type': 'RC',
        'total_area_m2': 150.5,
        'has_seismic_design': False,
        'elevation_m': 25.0,
        'flood_capacity': 50.0,
        'has_water_tank': False,
        'water_tank_method': 'legal_requirement'
    }

    # Exposure data with building info (as would come from evaal_ondemand_api.py)
    exposure_with_db = {
        'score': 50,
        'building': db_building_data,
        'flood_exposure': {'in_flood_zone': False}
    }

    try:
        result_db = agent.calculate_vulnerability(
            exposure_with_db,
            latitude=TEST_LAT,
            longitude=TEST_LON
        )
        print(f"  score: {result_db.get('score')}")
        print(f"  level: {result_db.get('level')}")
        print(f"  data_source: {result_db.get('data_source')}")

        factors = result_db.get('factors', {})
        print(f"  --- Key Factors ---")
        print(f"  building_age: {factors.get('building_age')}")
        print(f"  main_purpose: {factors.get('main_purpose', 'N/A')}")
        print(f"  structure_type: {factors.get('structure_type', 'N/A')}")
        print(f"  ground_floors: {factors.get('ground_floors', 'N/A')}")
        print(f"  has_basement: {factors.get('has_basement', 'N/A')}")
        print(f"  has_piloti: {factors.get('has_piloti', 'N/A')}")
        print(f"  elevation_m: {factors.get('elevation_m', 'N/A')}")
    except Exception as e:
        print(f"  [ERROR] {e}")
        result_db = None

    # ===== Test 2: Mock Data (Empty exposure) =====
    print("\n[2] Mock Data Test (empty exposure)")

    exposure_mock = {
        'score': 50,
        # No building data - will use defaults
    }

    try:
        result_mock = agent.calculate_vulnerability(
            exposure_mock,
            latitude=None,  # No coords - forces default
            longitude=None
        )
        print(f"  score: {result_mock.get('score')}")
        print(f"  level: {result_mock.get('level')}")
        print(f"  data_source: {result_mock.get('data_source')}")

        factors = result_mock.get('factors', {})
        print(f"  --- Key Factors ---")
        print(f"  building_age: {factors.get('building_age')} (default: 30)")
        print(f"  main_purpose: {factors.get('main_purpose', 'N/A')} (default: residential)")
        print(f"  structure_type: {factors.get('structure_type', 'N/A')} (default: RC)")
        print(f"  ground_floors: {factors.get('ground_floors', 'N/A')} (default: 3)")
    except Exception as e:
        print(f"  [ERROR] {e}")
        result_mock = None

    # ===== Comparison =====
    print("\n[3] DB vs Mock Comparison")
    if result_db and result_mock:
        db_age = result_db.get('factors', {}).get('building_age')
        mock_age = result_mock.get('factors', {}).get('building_age')

        if db_age == 22 and mock_age == 30:
            print(f"  Result: DB data used (age={db_age}) vs Mock default (age={mock_age})")
            print(f"  STATUS: DB DATA USED CORRECTLY")
            return True
        elif db_age == mock_age:
            print(f"  Result: Same age ({db_age}) - may be using defaults")
            print(f"  STATUS: NEEDS REVIEW")
            return None
        else:
            print(f"  Result: DB age={db_age}, Mock age={mock_age}")
            print(f"  STATUS: DIFFERENT VALUES (check source)")
            return True
    else:
        print(f"  STATUS: TEST FAILED")
        return False


def main():
    print("="*60)
    print("All 9 Vulnerability Agents - DB vs Mock Data Test")
    print("="*60)
    print(f"Test Coordinates: ({TEST_LAT}, {TEST_LON})")

    results = {}

    for risk_type in RISK_TYPES:
        results[risk_type] = test_single_vulnerability_agent(risk_type)

    # Summary
    print("\n" + "="*60)
    print("SUMMARY")
    print("="*60)

    for risk_type, status in results.items():
        if status is True:
            status_str = "DB DATA USED"
        elif status is False:
            status_str = "FAILED"
        else:
            status_str = "NEEDS REVIEW"
        print(f"  {risk_type:20s}: {status_str}")

    success_count = sum(1 for s in results.values() if s is True)
    print(f"\nTotal: {success_count}/{len(RISK_TYPES)} agents confirmed using DB data")


if __name__ == "__main__":
    main()
