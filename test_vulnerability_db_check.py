"""
Vulnerability Agent별 DB 데이터 사용 여부 확인
evaal_ondemand_api.py 플로우대로 실행하면서 각 에이전트가 DB 데이터를 받는지 테스트
"""
import sys
sys.path.insert(0, '/Users/odong-i/Desktop/SKALA/FinalProject/DB_ALL/modelops')

from modelops.batch.evaal_ondemand_api import (
    calculate_exposure, calculate_vulnerability, VULNERABILITY_AGENTS
)

# 테스트 좌표 (광주 치평동 - 건물 데이터 있음)
TEST_LAT = 35.1595
TEST_LON = 126.8526

RISK_TYPES = [
    'extreme_heat', 'extreme_cold', 'drought',
    'river_flood', 'urban_flood', 'wildfire',
    'water_stress', 'sea_level_rise', 'typhoon'
]


def test_single_vulnerability(risk_type: str):
    """단일 Vulnerability 에이전트 DB 데이터 사용 테스트"""
    print(f"\n{'='*60}")
    print(f"[{risk_type.upper()}] Vulnerability Agent")
    print('='*60)

    # Step 1: Exposure 계산 (building_data 수집됨)
    print("\n[Step 1] calculate_exposure() 호출...")
    e_result = calculate_exposure(
        latitude=TEST_LAT,
        longitude=TEST_LON,
        scenario='SSP245',
        target_year=2050,
        risk_type=risk_type
    )

    # building_data 확인
    building_data = e_result.get('building_data', {})
    print(f"  building_data 수집됨: {bool(building_data)}")
    if building_data:
        print(f"    - building_age: {building_data.get('building_age', 'N/A')}")
        print(f"    - main_purpose: {building_data.get('main_purpose', 'N/A')}")
        print(f"    - structure_type: {building_data.get('structure_type', 'N/A')}")
        print(f"    - ground_floors: {building_data.get('ground_floors', 'N/A')}")

    # Step 2: Vulnerability 계산
    print("\n[Step 2] calculate_vulnerability() 호출...")
    v_result = calculate_vulnerability(
        latitude=TEST_LAT,
        longitude=TEST_LON,
        risk_type=risk_type,
        exposure_data=e_result
    )

    # 결과 확인
    v_score = v_result.get('vulnerability_score', 'N/A')
    v_raw = v_result.get('raw_data', {})
    factors = v_raw.get('factors', {})
    data_source = v_raw.get('data_source', 'N/A')

    print(f"\n[결과]")
    print(f"  vulnerability_score: {v_score}")
    print(f"  data_source: {data_source}")
    print(f"  factors:")
    print(f"    - building_age: {factors.get('building_age', 'N/A')}")
    print(f"    - main_purpose: {factors.get('main_purpose', 'N/A')}")
    print(f"    - structure_type: {factors.get('structure_type', 'N/A')}")

    # DB 데이터 사용 여부 판단
    v_age = factors.get('building_age')
    is_db_used = (
        data_source == 'exposure' and
        v_age is not None and
        v_age != 30  # 기본값 아님
    )

    if is_db_used:
        print(f"\n  STATUS: DB DATA USED (age={v_age}, source={data_source})")
        return True
    elif data_source == 'exposure':
        print(f"\n  STATUS: EXPOSURE DATA USED (may be DB)")
        return True
    else:
        print(f"\n  STATUS: DEFAULT DATA USED (age={v_age}, source={data_source})")
        return False


def main():
    print("="*60)
    print("Vulnerability Agent별 DB 데이터 사용 확인")
    print("(evaal_ondemand_api.py 플로우)")
    print("="*60)
    print(f"테스트 좌표: ({TEST_LAT}, {TEST_LON})")

    results = {}
    for risk_type in RISK_TYPES:
        try:
            results[risk_type] = test_single_vulnerability(risk_type)
        except Exception as e:
            print(f"\n  [ERROR] {e}")
            import traceback
            traceback.print_exc()
            results[risk_type] = False

    # 요약
    print("\n" + "="*60)
    print("SUMMARY")
    print("="*60)
    for risk_type, ok in results.items():
        status = "DB/EXPOSURE" if ok else "DEFAULT"
        print(f"  {risk_type:20s}: {status}")

    success = sum(1 for v in results.values() if v)
    print(f"\n결과: {success}/{len(RISK_TYPES)} 에이전트가 DB/Exposure 데이터 사용")


if __name__ == "__main__":
    main()
