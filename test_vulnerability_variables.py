"""
Vulnerability Agent별 사용 변수 상세 확인 테스트
각 에이전트가 사용하는 모든 변수가 제대로 전달되는지 확인
"""
import sys
sys.path.insert(0, '/Users/odong-i/Desktop/SKALA/FinalProject/DB_ALL/modelops')

from modelops.batch.evaal_ondemand_api import (
    calculate_exposure, calculate_vulnerability
)

# 테스트 좌표 (광주 치평동)
TEST_LAT = 35.1595
TEST_LON = 126.8526

# 에이전트별 사용 변수 정의
AGENT_VARIABLES = {
    'extreme_heat': {
        'building': ['building_age', 'structure_type', 'main_purpose', 'has_seismic_design'],
        'other': []
    },
    'extreme_cold': {
        'building': ['building_age', 'structure_type', 'main_purpose', 'has_seismic_design'],
        'other': []
    },
    'drought': {
        'building': ['building_age', 'floors_below', 'structure_type', 'has_seismic_design'],
        'other': []
    },
    'river_flood': {
        'building': ['building_age', 'elevation_m', 'flood_capacity', 'has_seismic_design', 'has_piloti', 'floors_below'],
        'other': ['flood_exposure.in_flood_zone']
    },
    'urban_flood': {
        'building': ['building_age', 'elevation_m', 'has_seismic_design', 'floors_below', 'has_piloti'],
        'other': []
    },
    'wildfire': {
        'building': ['building_age', 'structure_type', 'main_purpose', 'has_seismic_design'],
        'other': []
    },
    'water_stress': {
        'building': ['building_age', 'ground_floors', 'total_area_m2', 'has_water_tank', 'water_tank_method'],
        'other': []
    },
    'sea_level_rise': {
        'building': ['elevation_m', 'building_age', 'floors_below', 'has_piloti', 'has_seismic_design', 'flood_capacity'],
        'other': []
    },
    'typhoon': {
        'building': ['building_age', 'structure_type', 'ground_floors', 'has_seismic_design', 'main_purpose'],
        'other': []
    }
}


def test_vulnerability_variables():
    """각 Vulnerability 에이전트가 받는 데이터 상세 확인"""
    print("=" * 70)
    print("Vulnerability Agent별 사용 변수 상세 확인")
    print("=" * 70)
    print(f"테스트 좌표: ({TEST_LAT}, {TEST_LON})")
    print()

    results = {}

    for risk_type, expected_vars in AGENT_VARIABLES.items():
        print(f"\n{'=' * 70}")
        print(f"[{risk_type.upper()}]")
        print('=' * 70)

        try:
            # Step 1: Exposure 계산
            e_result = calculate_exposure(
                latitude=TEST_LAT,
                longitude=TEST_LON,
                scenario='SSP245',
                target_year=2050,
                risk_type=risk_type
            )

            building_data = e_result.get('building_data', {})
            raw_data = e_result.get('raw_data', {})

            print(f"\n[Exposure 결과]")
            print(f"  building_data 주요 변수:")
            for var in expected_vars['building']:
                value = building_data.get(var, 'NOT FOUND')
                status = "" if value != 'NOT FOUND' and value is not None else " <-- MISSING!"
                print(f"    - {var}: {value}{status}")

            # Step 2: Vulnerability 계산
            v_result = calculate_vulnerability(
                latitude=TEST_LAT,
                longitude=TEST_LON,
                risk_type=risk_type,
                exposure_data=e_result
            )

            factors = v_result.get('factors', {})
            v_raw = v_result.get('raw_data', {})

            print(f"\n[Vulnerability 결과]")
            print(f"  score: {v_result.get('vulnerability_score')}")
            print(f"  data_source: {v_raw.get('data_source', 'N/A')}")
            print(f"  factors 확인:")

            missing_vars = []
            for var in expected_vars['building']:
                value = factors.get(var, 'NOT FOUND')
                # 일부 변수는 다른 이름으로 저장될 수 있음
                if value == 'NOT FOUND':
                    # 대체 이름 확인
                    alt_names = {
                        'floors_below': 'has_basement',
                        'has_piloti': 'has_piloti',
                    }
                    if var in alt_names:
                        value = factors.get(alt_names[var], 'NOT FOUND')

                status = "" if value != 'NOT FOUND' else " <-- MISSING!"
                if value == 'NOT FOUND':
                    missing_vars.append(var)
                print(f"    - {var}: {value}{status}")

            # flood_exposure 체크
            for other_var in expected_vars['other']:
                if 'flood_exposure' in other_var:
                    # raw_data를 보면 flood_exposure 구조가 전달되었는지 확인
                    in_flood_zone = v_raw.get('factors', {}).get('flood_barrier', 'N/A')
                    print(f"    - flood_exposure.in_flood_zone: (factors에 flood_barrier로 반영됨)")

            results[risk_type] = len(missing_vars) == 0

        except Exception as e:
            print(f"  [ERROR] {e}")
            import traceback
            traceback.print_exc()
            results[risk_type] = False

    # 요약
    print(f"\n{'=' * 70}")
    print("SUMMARY")
    print('=' * 70)
    for risk_type, success in results.items():
        status = "PASS" if success else "NEEDS REVIEW"
        print(f"  {risk_type:20s}: {status}")

    passed = sum(1 for v in results.values() if v)
    print(f"\n결과: {passed}/{len(results)} 에이전트 통과")


if __name__ == "__main__":
    test_vulnerability_variables()
